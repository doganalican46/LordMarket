<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lord Büfe&Market Satış</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/862/862819.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="@Url.Content("~/Assets/HomeAssets/style.css")" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        .numpad-box {
            background-color: #f9f9f9;
        }

        .numpad-container {
            width: 100%;
        }

        .numpad-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .numpad-key {
            flex: 1;
            margin: 3px;
            padding: 15px 0;
            font-size: 20px;
            text-align: center;
            border: none;
            border-radius: 8px;
            background-color: #e0e0e0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }

            .numpad-key:hover {
                background-color: #ccc;
            }


    </style>

</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1><i class="fas fa-barcode me-2"></i>Lord Büfe & Market Satış</h1>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <!-- Barcode Section -->
                <div class="barcode-section my-3">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light text-dark"><i class="fas fa-barcode"></i></span>
                        <input type="text" id="barkodInput" class="form-control" placeholder="Barkod okutun veya girin" autofocus>
                        <button type="button" class="btn btn-outline-dark" onclick="kameraAcSatis()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </div>

                <!-- Camera Area -->
                <div id="kameraAlani" class="mt-3" style="display:none;">
                    <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
                    <button type="button" class="btn btn-danger mt-2" onclick="kamerayiKapatSatis()">Kapat</button>
                </div>

                <!-- Payment Section -->
                <div class="payment-section">
                    <h5 class="mb-3"><i class="fas fa-money-bill-wave me-2 text-success"></i>Ödeme Seçenekleri</h5>

                    <div class="payment-methods d-flex flex-wrap gap-3">
                        <button type="button" class="btn btn-success odeme-btn btn-lg flex-fill rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2 fw-semibold"
                                data-tip="Nakit">
                            <i class="fas fa-money-bill"></i>Nakit
                        </button>
                        <button type="button" class="btn btn-info odeme-btn btn-lg flex-fill rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2 fw-semibold"
                                data-tip="Kart">
                            <i class="fas fa-credit-card"></i>Kart
                        </button>
                        <button type="button" class="btn btn-warning odeme-btn btn-lg flex-fill rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2 fw-semibold text-dark"
                                data-tip="Veresiye">
                            <i class="fas fa-hand-holding-usd"></i>Veresiye
                        </button>
                    </div>


                    <input type="hidden" id="odemeTipi" value="Nakit">

                    <div class="customer-select" id="customerSelectContainer" style="display: none;">
                        <label for="musteriSelect" class="form-label"><i class="fas fa-user me-2"></i>Müşteri Seçin:</label>
                        <select id="musteriSelect" class="form-select">
                            <option value="">Müşteri Seçin</option>
                            @foreach (var musteri in Model.Musteriler)
                            {
                                <option value="@musteri.ID">@musteri.MusteriAdSoyad</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Product Table -->
                <div class="product-table-container">
                    <table class="table table-striped table-hover" id="urunListesi">
                        <thead>
                            <tr>
                                <th>Ürün Adı</th>
                                <th>Fiyat (₺)</th>
                                <th>Adet</th>
                                <th>Toplam (₺)</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <input type="hidden" id="UrunListesiHidden" name="UrunListesi" />

                <!-- Actions Section -->
                <div class="payment-section mb-4">
                    <h4 class="fw-bold text-dark mb-3"><i class="fas fa-tools me-2 text-primary"></i>İşlem Paneli</h4>

                    <div class="row g-3">

                        <!-- Temizle -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn btn-danger w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded"
                                    onclick="temizle()">
                                <i class="fas fa-trash-alt"></i> Temizle
                            </button>
                        </div>

                        <!-- Beklet -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button id="bekletBtn" class="btn btn-secondary w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded"
                                    onclick="islemBeklet()">
                                <i class="fas fa-clock"></i> Beklet
                            </button>
                        </div>

                        <!-- Ürün İşlem -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn btn-success w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded"
                                    data-bs-toggle="modal" data-bs-target="#urunEkleModal">
                                <i class="fas fa-box-open"></i> Ürün İşlem
                            </button>
                        </div>

                        <!-- İskonto -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded text-white"
                                    style="background-color: #003d60;" data-bs-toggle="modal" data-bs-target="#iskontoModal">
                                <i class="fas fa-percent"></i> İskonto
                            </button>
                        </div>

                        <!-- Admin Panel -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="/Admin/Index" class="btn btn-warning w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded text-dark">
                                <i class="fas fa-toolbox"></i> Admin Paneli
                            </a>
                        </div>

                        <!-- Makbuz Yazdır -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn btn-info w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded text-white"
                                    data-bs-toggle="modal" data-bs-target="#makbuzModal">
                                <i class="fas fa-receipt"></i> Makbuz Yazdır
                            </button>
                        </div>

                        <!-- Veresiye Öde -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded text-white"
                                    style="background-color: #ff6a00;" data-bs-toggle="modal" data-bs-target="#borcOdeModal">
                                <i class="fas fa-hand-holding-usd"></i> Borç Öde
                            </button>
                        </div>

                        <!-- İade -->
                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded text-white"
                                    style="background-color: #dc3545;" onclick="iadeYap()">
                                <i class="fas fa-undo-alt"></i> İade Et
                            </button>
                        </div>

                        <!-- Toptancı İşlem -->
                        

                        <div class="col-6 col-md-4 col-lg-3">
                            <button class="btn w-100 d-flex align-items-center justify-content-center gap-2 py-2 shadow-sm rounded text-white"
                                    style="background-color: #6f42c1;"
                                    data-bs-toggle="modal" data-bs-target="#toptanciWizardModal">
                                <i class="fas fa-truck-loading"></i> Toptancı İşlem
                            </button>
                        </div>

                    </div>
                </div>


            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Total Section -->
                <div class="total-section">
                    <div id="toplamFiyat" style="font-size: 65px; font-weight: bold; color: white;">0.00 ₺</div>
                </div>

                <!-- Other Products Section -->
                <div class="other-product-section">
                    <h5><i class="fas fa-tag me-2"></i>Hızlı İşlem</h5>

                    <div class="other-product-container">
                        <!-- Price Display -->
                        <div class="price-display mb-3">
                            <input type="text" id="digerUrunFiyat" class="form-control form-control-lg text-center" placeholder="₺" readonly>
                        </div>

                        <!-- Combined Numpad and Add Button -->
                        <div class="numpad-add-container">
                            <!-- Numpad -->
                            <div class="numpad-box">
                                <div id="numpad" class="numpad-container">
                                    <div class="numpad-row">
                                        <button class="numpad-key fw-bold" onclick="numpadClick('7')">7</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('8')">8</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('9')">9</button>
                                    </div>
                                    <div class="numpad-row">
                                        <button class="numpad-key fw-bold" onclick="numpadClick('4')">4</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('5')">5</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('6')">6</button>
                                    </div>
                                    <div class="numpad-row">
                                        <button class="numpad-key fw-bold" onclick="numpadClick('1')">1</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('2')">2</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('3')">3</button>
                                    </div>
                                    <div class="numpad-row">
                                        <button class="numpad-key fw-bold" onclick="numpadClick('.')">.</button>
                                        <button class="numpad-key fw-bold" onclick="numpadClick('0')">0</button>
                                        <button class="numpad-key fw-bold" onclick="numpadBackspace()">
                                            <i class="fas fa-backspace"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Button (alt alta sıralanmış) -->
                            <div class="add-button-container d-flex flex-column gap-2">
                                <button class="btn btn-lg mt-3" style="background-color: #003d60; color:white; min-width:200px; height:125px; padding:0 20px;" onclick="digerUrunEkle()">
                                    <i class="fas fa-plus me-2"></i>EKLE
                                </button>

                                <button class="btn btn-success btn-lg w-250" type="button" onclick="adetHazirla()" style=" min-width:200px; height:125px; padding:0 20px;">Adet</button>
                            </div>




                        </div>
                    </div>
                </div>

                <!-- Quick Products -->
                <div class="quick-products">
                    <h5><i class="fas fa-bolt me-2"></i>Hızlı Satış</h5>
                    <div class="d-flex flex-wrap">
                        @foreach (var item in Model.HizliUrunler)
                        {
                            <button class="btn btn-danger btn-quick-product"
                                    onclick="hizliUrunEkle('@item.Barkod')"
                                    oncontextmenu="kaldirmakIcinSor(@item.ID); return false;">
                                <div>@item.UrunAd</div>
                                <div class="fw-bold">@item.UrunFiyat ₺</div>
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="makbuzModal" tabindex="-1" aria-labelledby="makbuzModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content mx-auto" style="width: 100%; max-width: 58mm; padding: 0; margin: 0;">
                <div class="modal-header py-1 justify-content-center">
                    <h5 class="modal-title" id="makbuzModalLabel" style="font-size: 13px;">İşlem Makbuzu</h5>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>

                <div id="printableReceipt"
                     style="font-family: 'Courier New', monospace; font-size: 15px; width: 100%; box-sizing: border-box; padding: 2px 3px; line-height: 1.1; word-break: break-word; overflow-wrap: break-word;">

                    <div style="font-weight: bold; font-size: 15px; text-align: center; margin-bottom: 2px;">LORD BÜFE & MARKET</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 2px;">TEL: 0544 940 8134</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 2px;">-----------------------</div>

                    <div style="font-weight: bold; margin-bottom: 1px;">
                        Tarih: @(Model?.SonSatis?.Tarih?.ToString("dd.MM.yyyy HH:mm") ?? "-")
                    </div>
                    <div style="font-weight: bold; margin-bottom: 1px;">
                        Satış No: @(Model?.SonSatis?.SatisNo?.ToString() ?? "-")
                    </div>
                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>

                    <table style="width: 100%; font-size: 13px; text-align: center; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="font-weight: bold; text-align: left;">Ürün</th>
                                <th>Ad</th>
                                <th style="font-weight: bold; text-align: right;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!string.IsNullOrEmpty(Model?.SonSatis?.UrunListesi))
                            {
                                foreach (var satir in Model.SonSatis.UrunListesi.Split('\n'))
                                {
                                    if (string.IsNullOrWhiteSpace(satir))
                                    {
                                        continue;
                                    }

                                    var parcalar = satir.Split(new[] { " - " }, StringSplitOptions.None);
                                    string urunAd = "-", adet = "-", tutar = "-";

                                    foreach (var parca in parcalar)
                                    {
                                        if (parca.StartsWith("Ürün: "))
                                        {
                                            urunAd = parca.Replace("Ürün: ", "").Trim();
                                        }
                                        else if (parca.StartsWith("Adet: "))
                                        {
                                            adet = parca.Replace("Adet: ", "").Trim();
                                        }
                                        else if (parca.StartsWith("Tutar: "))
                                        {
                                            tutar = parca.Replace("Tutar: ", "").Trim();
                                        }
                                    }

                                    <tr>
                                        <td style="font-weight: bold; text-align: left;">@urunAd</td>
                                        <td>@adet</td>
                                        <td style="font-weight: bold; text-align: right;">@tutar</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" style="font-weight: bold; text-align: center;">Ürün listesi mevcut değil</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>

                    <div style="font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; margin-bottom: 1px;">
                        <span>Toplam:</span>
                        <span>@(Model?.SonSatis?.ToplamTutar?.ToString() ?? "-") ₺</span>
                    </div>
                    <div style="font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 2px;">
                        <span>Ödeme Tipi:</span>
                        <span>@(Model?.SonSatis?.OdemeTipi ?? "-")</span>
                    </div>

                    @if (Model?.SonSatis?.MusteriID != null)
                    {
                        <div style="font-weight: bold; margin-bottom: 2px;">Müşteri: @(Model?.MusteriAdSoyad ?? "-")</div>
                    }

                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 2px;">MALİ DEĞERİ YOKTUR</div>
                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>

                    <div style="font-weight: bold; text-align: center; font-size: 13px;">
                        ADRES: NARLI CUMHURİYET MAH.<br />
                        13007.SK NO:12/A
                    </div>
                </div>

                <div class="modal-footer py-1 justify-content-center">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="printDiv('printableReceipt')">🖨 Yazdır</button>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="urunEkleModal" tabindex="-1" aria-labelledby="urunEkleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow">
                <div class="modal-header text-white" style="background-color: #003d60; color:white;">
                    <h5 class="modal-title" id="urunEkleModalLabel">Yeni Ürün Ekle/Güncelle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>

                <form action="/Home/YeniUrun" method="post" enctype="multipart/form-data">
                    <div class="modal-body">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="barkodInputyeniurun" class="form-label">Barkod</label>
                                <div class="input-group">
                                    <input type="text" name="Barkod" id="barkodInputyeniurun" class="form-control" required />
                                    <button type="button" class="btn btn-outline-secondary" onclick="kameraAc()">📷</button>
                                </div>
                            </div>
                            <div id="kameraAlaniyeniurun" class="mt-3" style="display:none;">
                                <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
                                <button type="button" class="btn btn-danger mt-2" onclick="kamerayiKapat()">Kapat</button>
                            </div>



                            <div class="col-md-6">
                                <label for="UrunAd" class="form-label">Ürün Adı</label>
                                <input type="text" name="UrunAd" class="form-control" required />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunKategori" class="form-label">Ürün Kategorisi</label>
                                <input type="text" name="UrunKategori" class="form-control" />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunAlisFiyati" class="form-label">Ürün Alış Fiyatı</label>
                                <input type="number" step="0.01" name="UrunAlisFiyati" id="UrunAlisFiyati" class="form-control" />
                            </div>

                            <div class="col-md-6">
                                <label for="KDVOran" class="form-label">KDV Oranı (%)</label>
                                <input type="number" step="0.01" name="KDVOran" id="KDVOran" class="form-control" value="18" />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunFiyat" class="form-label">Hesaplanan Ürün Fiyatı</label>
                                <input type="number" step="0.01" name="UrunFiyat" id="UrunFiyat" class="form-control" required />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunResmi" class="form-label">Ürün Resmi</label>
                                <input type="text" name="UrunResmi" class="form-control" />
                            </div>

                            <div class="col-md-6 mt-4 d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="HizliUrunMu" value="true" id="HizliUrunMu" />
                                    <label class="form-check-label" for="HizliUrunMu">Hızlı Ürün mü?</label>
                                </div>
                                <input type="hidden" name="HizliUrunMu" value="false" />
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn " style="background-color: #003d60; color:white;">Kaydet</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- İskonto Modal -->
    <div class="modal fade" id="iskontoModal" tabindex="-1" aria-labelledby="iskontoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header  text-white" style="background-color: #003d60;">
                    <h5 class="modal-title" id="iskontoModalLabel">İskonto Uygula</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <label for="iskontoOrani" class="form-label">İskonto Oranı (%)</label>
                    <input type="number" class="form-control" id="iskontoOrani" placeholder="Örneğin: 10">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn" style="background-color: #003d60; color:white;" onclick="applyDiscount()">Uygula</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="borcOdeModal" tabindex="-1" aria-labelledby="borcOdeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg border-0 rounded-3">

                <!-- Header -->
                <div class="modal-header " style="background-color: #003d60; color:white;">
                    <h5 class="modal-title fw-bold" id="borcOdeModalLabel">
                        <i class="bi bi-cash-coin me-2"></i> Borç Öde
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Body -->
                <div class="modal-body p-4">
                    <form id="borcOdeForm">

                        <!-- Müşteri Seçimi -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Müşteri Seçin</label>
                            <select id="borcMusteriSelect" class="form-select shadow-sm" onchange="getMusteriBorc()" required>
                                <option selected disabled value="">Müşteri Seçin...</option>
                                @foreach (var item in Model.Musteriler)
                                {
                                    <option value="@item.ID">@item.MusteriAdSoyad</option>
                                }
                            </select>
                        </div>

                        <!-- Seçili Müşteri Borcu -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Toplam Borç</label>
                            <input type="text" id="ToplamBorc" class="form-control shadow-sm" readonly />
                        </div>

                        <!-- Ödenecek Tutar -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ödenecek Tutar</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text">₺</span>
                                <input type="text" id="OdenenBorcTutar" class="form-control" placeholder="0" required />
                            </div>
                        </div>

                        <!-- Ödeme Tipi -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ödeme Tipi</label>
                            <select id="OdemeTipi" class="form-select shadow-sm">
                                <option value="Nakit">Nakit</option>
                                <option value="Kart">Kart</option>
                                <option value="RaporaYansitma">Rapora Yansıtma</option>
                            </select>
                        </div>

                        <!-- Not -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Kısa Not (İsteğe Bağlı)</label>
                            <textarea id="BorcNot" class="form-control shadow-sm" rows="2" placeholder="Açıklama..."></textarea>
                        </div>
                    </form>
                </div>

                <!-- Footer -->
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-light border shadow-sm" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> İptal
                    </button>
                    <button type="button" class="btn " style="background-color: #003d60; color:white;" onclick="submitBorcOdeForm()">
                        <i class="bi bi-check2-circle me-1"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Wizard Modal -->
    <div class="modal fade" id="toptanciWizardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header rounded-top-3" style="background-color:#003d60;color:white;">
                    <h5 class="modal-title fw-bold"><i class="bi bi-gear me-2"></i>Toptancı İşlem Sihirbazı</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-4">
                    <!-- Step Indicator -->
                    <div class="progress mb-4" style="height: 10px;">
                        <div id="wizardProgress" class="progress-bar bg-primary" role="progressbar" style="width: 33%;"></div>
                    </div>

                    <!-- Step 1: Toptancı Seçimi -->
                    <div class="wizard-step" id="step1">
                        <h6 class="fw-bold mb-3"><i class="bi bi-person-badge me-2"></i>Toptancı Seçimi</h6>

                        <!-- Kart -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <!-- Toptancı Select -->
                                <div class="mb-4">
                                    <label for="wizardToptanciSelect" class="form-label fw-semibold text-primary">
                                        <i class="bi bi-search me-1"></i> Toptancı Seçin
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0">
                                            <i class="bi bi-person"></i>
                                        </span>
                                        <select id="wizardToptanciSelect" class="form-select border-start-0 ps-0" onchange="getToptanciAlacakVerecekWizard()">
                                            <option selected disabled>Bir toptancı seçin...</option>
                                            @foreach (var item in Model.Kullanicilar)
                                            {
                                                <option value="@item.ID">@item.Username</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <!-- Finansal Durum (Kartçıklar) -->
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="p-3 bg-success bg-opacity-10 rounded shadow-sm d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-success fw-semibold">Alacak</div>
                                                <div id="WizardAlacak" class="fw-bold fs-6">0 ₺</div>
                                            </div>
                                            <i class="bi bi-arrow-down-left-circle text-success fs-3"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-danger bg-opacity-10 rounded shadow-sm d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-danger fw-semibold">Verecek</div>
                                                <div id="WizardVerecek" class="fw-bold fs-6">0 ₺</div>
                                            </div>
                                            <i class="bi bi-arrow-up-right-circle text-danger fs-3"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="p-3 bg-primary bg-opacity-10 rounded shadow-sm d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-primary fw-semibold">Net Durum</div>
                                                <div id="WizardNetDurum" class="fw-bold fs-5">0 ₺</div>
                                            </div>
                                            <i class="bi bi-calculator text-primary fs-3"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Step 2: İşlem Detayları -->
                    <div class="wizard-step d-none" id="step2">
                        <h6 class="fw-bold mb-3"><i class="bi bi-pencil-square me-2"></i>İşlem Detayları</h6>

                        <!-- Güncel Net Durum -->
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-calculator me-2"></i> Güncel Net Durum</span>
                            <strong id="WizardNetDurumStep2">0 ₺</strong>
                        </div>

                        <div class="mb-3">
                            <label for="WizardTutar" class="form-label fw-semibold">
                                <i class="bi bi-currency-dollar me-1"></i> İşlem Tutarı
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">₺</span>
                                <input type="number" id="WizardTutar" class="form-control"
                                       placeholder="0.00" required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">İşlem Tipi</label>
                            <select id="WizardTipi" class="form-select">
                                <option value="Alacak">Alacak Ekle</option>
                                <option value="Verecek">Verecek Ekle</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label fw-semibold">Not</label>
                            <textarea id="WizardNot" class="form-control" rows="3"></textarea>
                        </div>
                    </div>


                    <!-- Step 3: Özet & Onay -->
                    <div class="wizard-step d-none" id="step3">
                        <h6 class="fw-bold mb-3"><i class="bi bi-check2-circle me-2"></i>Özet & Onay</h6>

                        <div class="row g-3">
                            <!-- Sol: İşlem Özeti -->
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-primary bg-opacity-10 fw-semibold text-primary">
                                        <i class="bi bi-file-text me-1"></i> İşlem Özeti
                                    </div>
                                    <div class="card-body">
                                        <p><i class="bi bi-person me-2 text-secondary"></i><strong>Toptancı:</strong> <span id="SummaryToptanci"></span></p>
                                        <p><i class="bi bi-cash-coin me-2 text-success"></i><strong>Tutar:</strong> <span id="SummaryTutar"></span></p>
                                        <p><i class="bi bi-repeat me-2 text-warning"></i><strong>İşlem Tipi:</strong> <span id="SummaryTipi"></span></p>
                                        <p><i class="bi bi-pencil-square me-2 text-info"></i><strong>Not:</strong> <span id="SummaryNot"></span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Sağ: Güncel Durum -->
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-success bg-opacity-10 fw-semibold text-success">
                                        <i class="bi bi-graph-up me-1"></i> Güncel Durum
                                    </div>
                                    <div class="card-body">
                                        <p><i class="bi bi-arrow-down-left-circle text-success me-2"></i><strong>Toplam Alacak:</strong> <span id="SummaryAlacak">0 ₺</span></p>
                                        <p><i class="bi bi-arrow-up-right-circle text-danger me-2"></i><strong>Toplam Verecek:</strong> <span id="SummaryVerecek">0 ₺</span></p>
                                        <p class="border-top pt-2">
                                            <i class="bi bi-calculator me-2"></i>
                                            <strong>Net Durum:</strong>
                                            <span id="SummaryNetDurum" class="fw-bold">0 ₺</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alt bilgi -->
                        <div class="alert alert-light border mt-4 d-flex align-items-center shadow-sm">
                            <i class="bi bi-info-circle-fill text-primary me-2 fs-5"></i>
                            <div>
                                Lütfen bilgileri kontrol edin. <strong>Onayla</strong> dediğinizde işlem kaydedilecektir.
                            </div>
                        </div>
                    </div>


                </div>

                <!-- Modal Footer -->
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary d-none" id="prevStepBtn"><i class="bi bi-arrow-left"></i> Geri</button>
                    <button type="button" class="btn btn-primary" id="nextStepBtn">İleri <i class="bi bi-arrow-right"></i></button>
                    <button type="button" class="btn btn-success d-none" id="confirmBtn"><i class="bi bi-check-lg"></i> Onayla</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        let reloadTimer;
        let checkInterval;
        let adetBekleniyor = null;
        function adetHazirla() {
            let girilenAdet = parseInt($('#digerUrunFiyat').val());
            if (!girilenAdet || girilenAdet < 1) {
                Swal.fire("Geçerli bir adet girin");
                return;
            }
            adetBekleniyor = girilenAdet;
            $('#digerUrunFiyat').val('');
            $('#barkodInput').focus();
        }

        window.addEventListener('load', function () {
            checkInterval = setInterval(kontrolVeYenile, 10 * 60 * 1000);
        });

        function kontrolVeYenile() {
            let urunSatirSayisi = $('#urunListesi tbody tr').not('.iskonto-satiri').length;
            if (urunSatirSayisi === 0) {
                console.log("Ürün listesi boş, yenileme için onay isteniyor.");

                Swal.fire({
                    title: 'Sayfa Yenilensin mi?',
                    text: 'Ürün listesi boş görünüyor. Sayfa 10 saniye içinde yenilenecek.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Evet, yenile',
                    cancelButtonText: 'İptal',
                    timer: 10000,
                    timerProgressBar: true,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        reloadTimer = setTimeout(() => {
                            console.log("Otomatik yenileme gerçekleşiyor.");
                            location.reload();
                        }, 10000);
                        $('#barkodInput').val("").focus();
                    },
                    preConfirm: () => {
                        clearTimeout(reloadTimer);
                        console.log("Kullanıcı yenilemeyi onayladı.");
                        location.reload();
                        $('#barkodInput').val("").focus();
                    },
                    willClose: () => {
                        clearTimeout(reloadTimer);
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        console.log("Kullanıcı yenilemeyi iptal etti.");
                        clearTimeout(reloadTimer);
                        $('#barkodInput').val("").focus();

                    }
                });

            } else {
                console.log("Ürün listesi dolu, yenileme yapılmadı.");
            }
        }





        $(document).ready(function () {
            $.ajax({
                url: '/Home/BeklemedeIslemVarMi',
                type: 'GET',
                success: function (res) {
                    if (res.varMi) {
                        // Son 5 dakika içinde beklemede işlem var
                        $('#bekletBtn')
                            .removeClass('btn-secondary')
                            .addClass('btn-warning')
                            .html('<i class="fas fa-hourglass-half me-2"></i>Bekleyen İşlemi Getir')
                            .attr('onclick', 'bekleyenIslemiGetir()')
                            .attr('title', 'Bekleyen işlemi getir');
                    } else {
                        // Yoksa normal beklet butonu
                        $('#bekletBtn')
                            .removeClass('btn-warning')
                            .addClass('btn-secondary')
                            .html('<i class="fas fa-clock me-2"></i>İşlem Beklet')
                            .attr('onclick', 'islemBeklet()')
                            .attr('title', 'İşlemi daha sonra devam etmek üzere beklet');
                    }
                }
            });
        });




        window.addEventListener("DOMContentLoaded", function () {
            document.getElementById("toptanciTrigger").click();
        });

        window.addEventListener("DOMContentLoaded", function () {
            fetch("/Home/ToptanciBildirimi")
                .then(response => {
                    if (!response.ok) {
                        // Hata varsa sessizce yakala, ekrana yazdırma
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    // Burada hiç ekrana yazma, sessizce tamamlandı
                })
                .catch(error => {
                    // Hata olursa sadece konsola yaz
                    console.error("Mail kontrol hatası:", error);
                });


        });


        const alisInput = document.getElementById("UrunAlisFiyati");
        const kdvInput = document.getElementById("KDVOran");
        const fiyatInput = document.getElementById("UrunFiyat");

        function hesaplaFiyat() {
            let alis = parseFloat(alisInput.value) || 0;
            let kdv = parseFloat(kdvInput.value) || 0;
            let hesaplanan = alis + (alis * kdv / 100);
            fiyatInput.value = hesaplanan.toFixed(2);
        }

        alisInput.addEventListener("input", hesaplaFiyat);
        kdvInput.addEventListener("input", hesaplaFiyat);

        let html5QrCode;


        function kameraAc() {
            document.getElementById("kameraAlaniyeniurun").style.display = "block";

            html5QrCode = new Html5Qrcode("reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Arka kamera olup olmadığını kontrol et
                    let backCamera = devices.find(device => device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("environment"));
                    let kameraId = backCamera ? backCamera.id : devices[0].id;

                    html5QrCode.start(
                        kameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        decodedText => {
                            document.getElementById("barkodInputyeniurun").value = decodedText;
                            kamerayiKapat();
                        },
                        errorMessage => {
                            // Hataları sessizce geç
                        }
                    );
                }
            }).catch(err => {
                alert("Kamera erişim hatası: " + err);
            });
        }

        function kamerayiKapat() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById("kameraAlaniyeniurun").style.display = "none";
                });
            }
        }






        function kameraAcSatis() {
            document.getElementById("kameraAlani").style.display = "block";

            html5QrCode = new Html5Qrcode("reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    let backCamera = devices.find(device => device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("environment"));
                    let kameraId = backCamera ? backCamera.id : devices[0].id;

                    html5QrCode.start(
                        kameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        decodedText => {
                            document.getElementById("barkodInput").value = decodedText;
                            kamerayiKapatSatis();
                            barkodAra();
                        },
                        errorMessage => {
                            // Hataları sessizce geç
                        }
                    );
                }
            }).catch(err => {
                alert("Kamera erişim hatası: " + err);
            });
        }

        window.onload = function () {
            $('#barkodInput').val("").focus();
        };



        function kamerayiKapatSatis() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById("kameraAlani").style.display = "none";
                });
            }
        }

        document.getElementById("barkodInputyeniurun").addEventListener("change", function () {
            const barkod = this.value;

            if (barkod.trim() === "") return;

            fetch(`/Home/BarkodAraYeniUrun?barkod=${encodeURIComponent(barkod)}`)
                .then(response => {
                    if (!response.ok) throw new Error("Sunucu hatası");
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        document.querySelector('input[name="UrunAd"]').value = data.UrunAd || "";
                        document.querySelector('input[name="UrunKategori"]').value = data.UrunKategori || "";
                        document.querySelector('input[name="UrunAlisFiyati"]').value = data.UrunAlisFiyati || "";
                        document.querySelector('input[name="KDVOran"]').value = data.KDVOran || "";
                        document.querySelector('input[name="UrunFiyat"]').value = data.UrunFiyat || "";
                        document.querySelector('input[name="UrunResmi"]').value = data.UrunResmi || "";

                        if (data.HizliUrunMu === true) {
                            document.getElementById("HizliUrunMu").checked = true;
                        } else {
                            document.getElementById("HizliUrunMu").checked = false;
                        }
                    }
                })
                .catch(error => {
                    console.error("Hata:", error);
                });
        });
        function islemBeklet() {
            let urunlerText = '';
            let urunSatirlari = $('#urunListesi tbody tr');

            if (urunSatirlari.length === 0) {
                Swal.fire({
                    title: 'Ürün listesi boş!',
                    text: 'Lütfen önce ürün ekleyin.',
                    icon: 'warning',
                    confirmButtonText: 'Tamam'
                });
                $('#barkodInput').val('').focus();

                return;
            }

            urunSatirlari.each(function () {
                let urunAd = $(this).find('td:eq(0)').text().trim();
                let adet = $(this).find('.adet').text().trim();
                let fiyat = $(this).find('.fiyat').text().trim();
                urunlerText += `Ürün: ${urunAd} - Adet: ${adet} - Tutar: ${fiyat}\n`;
            });

            $.ajax({
                url: '/Home/SatisYap',
                type: 'POST',
                data: {
                    OdemeTipi: 'Beklemede',
                    UrunListesi: urunlerText,
                    MusteriID: null
                },
                success: function (res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'info',
                            title: 'İşlem Bekletildi',
                            text: 'Satış işlemi beklemeye alındı.',
                            timer: 600,
                            showConfirmButton: false
                        });

                        temizle();  // Swal'dan sonra fonksiyonu çağır
                        location.reload();

                        $('#bekletBtn')
                            .removeClass('btn-secondary')
                            .addClass('btn-warning')
                            .html('<i class="fas fa-hourglass-half me-2"></i>Bekleyen İşlemi Getir')
                            .attr('onclick', 'bekleyenIslemiGetir()');
                    } else {
                        Swal.fire('Hata', res.message, 'error');
                    }
                }

            });
        }

        function bekleyenIslemiGetir() {
            $.ajax({
                url: '/Home/BeklemedeSatisGetir',
                type: 'POST',
                success: function (data) {
                    if (data.success && data.urunListesi) {
                        let satirlar = data.urunListesi.trim().split('\n');
                        $('#urunListesi tbody').empty();
                        satirlar.forEach(function (satir) {
                            let parcala = satir.split('-');
                            if (parcala.length === 3) {
                                let urunAd = parcala[0].replace("Ürün:", "").trim();
                                let adet = parseInt(parcala[1].replace("Adet:", "").trim());
                                let fiyat = parseFloat(parcala[2].replace("Tutar:", "").trim());

                                let toplam = (adet * fiyat).toFixed(2);

                                let yeniSatir = `
                                                            <tr data-barkod="${urunAd}">
                                                                <!-- İstersen gerçek barkodla değiştir -->
                                                                <td>${urunAd}</td>
                                                                <td class="fiyat">${fiyat}</td>
                                                                <td class="adet">${adet}</td>
                                                                <td class="satirToplam">${toplam}</td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-primary" onclick="adetDegistir(this, 1)"><i class="fas fa-plus"></i></button>
                                                                    <button class="btn btn-sm btn-warning" onclick="adetDegistir(this, -1)"><i class="fas fa-minus"></i></button>
                                                                    <button class="btn btn-sm btn-danger" onclick="sil(this)"><i class="fas fa-trash"></i></button>
                                                                </td>
                                                            </tr>`;
                                $('#urunListesi tbody').append(yeniSatir);
                            }
                        });
                        $('#barkodInput').val('').focus();


                        Swal.fire({
                            icon: 'success',
                            title: 'İşlem Yüklendi',
                            text: 'Bekleyen işlem listeye eklendi.',
                            timer: 600,
                            showConfirmButton: false,
                            willClose: () => {
                                $('#barkodInput').val('').focus();
                            }
                        }).then(() => {
                            // Swal kapanınca çalışır
                            $('#barkodInput').val('').focus();
                        });


                        $('#bekletBtn')
                            .removeClass('btn-warning')
                            .addClass('btn-secondary')
                            .html('<i class="fas fa-clock me-2"></i>İşlem Beklet')
                            .attr('onclick', 'islemBeklet()');

                        updateGenelToplam(); // toplamları güncelle
                        $('#barkodInput').val('').focus();
                    } else {
                        Swal.fire('Uyarı', 'Beklemede işlem bulunamadı.', 'info');
                    }
                }
            });
        }






        function kaldirmakIcinSor(id) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu ürünü hızlı ürünlerden kaldırmak istiyor musunuz?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, kaldır!',
                cancelButtonText: 'Vazgeç',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then((result) => {
                if (result.isConfirmed) {
                    // AJAX ile hızlı üründen kaldır
                    $.ajax({
                        url: '/Home/HizliUrunKaldir', // bu route senin controllerda olacak
                        type: 'POST',
                        data: { id: id },
                        success: function () {
                            Swal.fire({
                                icon: 'success',
                                title: 'Kaldırıldı!',
                                text: 'Ürün hızlı ürünlerden kaldırıldı.',
                                timer: 600,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload(); // ekranı yenile
                            });
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: 'Ürün kaldırılamadı.',
                            });
                        }
                    });
                }
            });
        }


        $(document).ready(function () {
            if (localStorage.getItem('fisYazdirClicked') === 'true') {
                localStorage.removeItem('fisYazdirClicked'); // işaret kaldır
                // Otomatik olarak makbuz modal butonuna tıkla
                $('button[data-bs-target="#makbuzModal"]').trigger('click');
            }
        });

        var toplam = 0;
        let digerUrunSayac = 0;

        function temizle() {
            $('#urunListesi tbody').empty();
            toplam = 0;
            $('#toplamFiyat').text("0.00 ₺");
            $('#barkodInput').val('').focus();
            $('#odemeTipi').val('Nakit');
            $('#digerUrunFiyat').val('');
            $('.odeme-btn');
            $('.odeme-btn[data-tip="Nakit"]');
            $('#musteriSelect').val('');
            $('#customerSelectContainer').hide();
            $('#iskontoBtn').html('<i class="fas fa-percent me-2"></i>İskonto');
            $('#barkodInput').val('').focus();

        }

        function updateGenelToplam() {
            let toplamYeni = 0;
            $('#urunListesi tbody tr').each(function () {
                let satir = $(this);
                if (!satir.hasClass('iskonto-satiri')) {
                    let satirToplam = parseFloat(satir.find('.satirToplam').text());
                    if (!isNaN(satirToplam)) {
                        toplamYeni += satirToplam;
                    }
                }
            });

            $('#toplamFiyat').text(toplamYeni.toFixed(2) + ' ₺');
        }



        function barkodAra() {
            let eklenecekAdet = adetBekleniyor ?? 1;
            adetBekleniyor = null;

            var barkod = $('#barkodInput').val();
            if (barkod.trim() === "") return;


            let mevcutSatir = $(`#urunListesi tbody tr[data-barkod='${barkod}']`);
            if (mevcutSatir.length > 0) {
                let adetCell = mevcutSatir.find('.adet');
                let mevcutAdet = parseInt(adetCell.text());
                let eklenecekAdet = adetBekleniyor ?? 1;
                let yeniAdet = mevcutAdet + eklenecekAdet;
                adetBekleniyor = null;
                adetCell.text(yeniAdet);

                let fiyat = parseFloat(mevcutSatir.find('.fiyat').text());
                mevcutSatir.find('.satirToplam').text((yeniAdet * fiyat).toFixed(2));

                updateGenelToplam();
                $('#barkodInput').val("").focus();
                return;
            }

            $.ajax({
                url: '/Home/BarkodAra',
                type: 'POST',
                data: { barkod: barkod },
                success: function (res) {
                    if (res.success) {
                        let toplamSatir = res.fiyat;

                        $('#urunListesi tbody').prepend(
                            `<tr data-barkod="${barkod}">
                                                                <td>${res.urunAd}</td>
                                                                <td class="fiyat">${res.fiyat}</td>
<td class="adet">${eklenecekAdet}</td>
<td class="satirToplam">${(eklenecekAdet * res.fiyat).toFixed(2)}</td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-primary" onclick="adetDegistir(this, 1)"><i class="fas fa-plus"></i></button>
                                                                    <button class="btn btn-sm btn-warning" onclick="adetDegistir(this, -1)"><i class="fas fa-minus"></i></button>
                                                                    <button class="btn btn-sm btn-danger" onclick="sil(this)"><i class="fas fa-trash"></i></button>
                                                                </td>
                                                            </tr>`
                        );
                        updateGenelToplam();
                        $('#barkodInput').val("").focus();
                    } else {
                        Swal.fire({
                            title: 'Ürün bulunamadı',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Tamam',
                            cancelButtonText: 'Ürün Ekle',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.dismiss === Swal.DismissReason.cancel) {
                                // Barkod değerini ürün ekleme modalındaki input'a ata
                                $('#barkodInputyeniurun').val(barkod);

                                // Modalı aç
                                var myModal = new bootstrap.Modal(document.getElementById('urunEkleModal'));
                                myModal.show();
                            }
                        });

                        $('#barkodInput').val("").focus();
                    }

                },
                error: function () {
                    Swal.fire({
                        title: 'Bir hata oluştu',
                        text: 'Lütfen tekrar deneyin.',
                        icon: 'error',
                        confirmButtonText: 'Tamam'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.reload();
                        }
                    });
                }
            });
        }

        function adetDegistir(btn, degisim) {
            let satir = $(btn).closest('tr');
            let adetCell = satir.find('.adet');
            let adet = parseInt(adetCell.text());

            adet += degisim;
            if (adet < 1) return;

            adetCell.text(adet);

            let fiyat = parseFloat(satir.find('.fiyat').text());
            satir.find('.satirToplam').text((adet * fiyat).toFixed(2));
            $('#barkodInput').val('').focus();
            updateGenelToplam();
        }

        function sil(btn) {
            $(btn).closest('tr').remove();
            $('#barkodInput').val('').focus();
            updateGenelToplam();
        }

        $('#barkodInput').keypress(function (e) {
            if (e.which == 13) {
                barkodAra();
                e.preventDefault();
            }
        });

        function satisYap() {
            let odemeTipi = $('#odemeTipi').val();
            let musteriID = odemeTipi === 'Veresiye' ? $('#musteriSelect').val() : null;

            let urunlerText = '';
            let urunSatirlari = $('#urunListesi tbody tr');

            if (urunSatirlari.length === 0) {
                Swal.fire({
                    title: 'Ürün listesi boş!',
                    text: 'Lütfen önce ürün ekleyin.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Tamam',
                    cancelButtonText: 'Ürün Ekle',
                    reverseButtons: true
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        var modal = new bootstrap.Modal(document.getElementById('urunEkleModal'));
                        modal.show();
                    } else {
                        $('#barkodInput').focus();
                        location.reload();
                    }
                });
                return;
            }

            if (odemeTipi === 'Veresiye' && (!musteriID || musteriID === "")) {
                Swal.fire({
                    title: 'Uyarı',
                    text: 'Veresiye satış için müşteri seçmelisiniz.',
                    icon: 'info',
                    confirmButtonText: 'Tamam'
                }).then(() => {
                    $('#barkodInput').focus();

                });
                return;
            }

            urunSatirlari.each(function () {
                let urunAd = $(this).find('td:eq(0)').text().trim();
                let adet = $(this).find('.adet').text().trim();
                let fiyat = $(this).find('.fiyat').text().trim();
                urunlerText += `Ürün: ${urunAd} - Adet: ${adet} - Tutar: ${fiyat}\n`;
            });

            $.ajax({
                url: '/Home/SatisYap',
                type: 'POST',
                data: {
                    OdemeTipi: odemeTipi,
                    UrunListesi: urunlerText,
                    MusteriID: musteriID
                },
                success: function (res) {
                    if (res.success) {
                        let odemeTipi = $('#odemeTipi').val(); // Ödeme tipini burada da kontrol et
                        let baslik = odemeTipi === 'Iade' ? 'İade Tamamlandı!' : 'Satış Tamamlandı!';
                        let mesaj = odemeTipi === 'Iade' ? 'İade işlemi başarıyla gerçekleştirildi.' : 'Satış işlemi başarıyla gerçekleştirildi.';

                        Swal.fire({
                            icon: 'success',
                            title: baslik,
                            text: mesaj,
                            timer: 600,
                            timerProgressBar: true,
                            showConfirmButton: false,
                            willClose: () => {
                                temizle();
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Hata',
                            text: 'Hata: ' + res.message,
                            icon: 'error',
                            timer: 600,
                            timerProgressBar: true,
                            confirmButtonText: 'Tamam',
                            willClose: () => {
                                location.reload();
                            }
                        });
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Sistemsel Hata',
                        text: 'Satış işlemi sırasında sistemsel bir hata oluştu.',
                        timer: 600,
                        timerProgressBar: true,
                        showConfirmButton: false,
                        willClose: () => {
                            location.reload();
                        }
                    });

                    console.error("Hata Detayı:", xhr.responseText, status, error);
                }
            });
        }

        $('#iskontoModal, #makbuzModal, #borcOdeModal').on('hidden.bs.modal', function () {
            $('#iskontoModal').modal('hide');
            $('#makbuzModal').modal('hide');
            $('#borcOdeModal').modal('hide');

            setTimeout(function () {
                const input = $('#barkodInput');
                input.val('');
                input[0].scrollIntoView({ behavior: "smooth", block: "center" });
                input.focus();
            }, 100);
        });



        function hizliUrunEkle(barkod) {
            $('#barkodInput').val(barkod);
            barkodAra();
        }

        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('digerUrunFiyat');
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    digerUrunEkle();
                }
            });
        });

        function digerUrunEkle() {
            let fiyatInput = $('#digerUrunFiyat');
            let fiyat = parseFloat(fiyatInput.val());

            if (isNaN(fiyat) || fiyat <= 0) {
                Swal.fire({
                    title: 'Geçersiz Fiyat',
                    text: 'Lütfen geçerli bir fiyat girin.',
                    icon: 'warning',
                    confirmButtonText: 'Tamam'
                });
                fiyatInput.value = "";
                fiyatInput.focus();
                return;
            }

            digerUrunSayac++;
            let barkodDegeri = `digerUrun${digerUrunSayac}`;
            let urunAdi = digerUrunSayac === 1 ? "Diğer Ürün" : `Diğer Ürün ${digerUrunSayac}`;

            $('#urunListesi tbody').append(
                `<tr data-barkod="${barkodDegeri}">
                                                                <td>${urunAdi}</td>
                                                                <td class="fiyat">${fiyat.toFixed(2)}</td>
                                                                <td class="adet">1</td>
                                                                <td class="satirToplam">${fiyat.toFixed(2)}</td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-primary" onclick="adetDegistir(this, 1)"><i class="fas fa-plus"></i></button>
                                                                    <button class="btn btn-sm btn-warning" onclick="adetDegistir(this, -1)"><i class="fas fa-minus"></i></button>
                                                                    <button class="btn btn-sm btn-danger" onclick="sil(this)"><i class="fas fa-trash"></i></button>
                                                                </td>
                                                            </tr>`
            );

            updateGenelToplam();
            fiyatInput.val("");
            barkodInput.focus();
        }

        $('.odeme-btn').click(function () {
            $('.odeme-btn');
            $(this);

            let secilenTip = $(this).data('tip');
            $('#odemeTipi').val(secilenTip);

            if (secilenTip === 'Veresiye') {
                $('#customerSelectContainer').show();
            } else {
                $('#customerSelectContainer').hide();
                $('#musteriSelect').val('');
            }
        });

        $(document).ready(function () {
            $('#barkodInput').focus();
        });

        $(document).ready(function () {
            $(".odeme-btn").click(function () {
                $(".odeme-btn");
                $(this);

                var tip = $(this).data("tip");
                $("#odemeTipi").val(tip);

                if (tip === "Veresiye") {
                    $("#customerSelectContainer").slideDown();
                } else {
                    $("#customerSelectContainer").slideUp();
                }

                if (tip === "Veresiye") {
                    if ($("#musteriSelect").val()) {
                        satisYap();
                    } else {
                        $("#musteriSelect").off("change").on("change", function () {
                            if ($(this).val()) {
                                satisYap();
                            }
                        });
                    }
                } else {
                    satisYap();
                }
            });
        });
        function printDiv(divId) {
            var printContents = document.getElementById(divId).innerHTML;
            var originalContents = document.body.innerHTML;

            document.body.innerHTML = '<div style="width: 58mm; margin: 0 auto; font-family: \'Courier New\', monospace; font-size: 11px; font-weight: bold; box-sizing: border-box;">' + printContents + '</div>';

            window.print();

            document.body.innerHTML = originalContents;
            location.reload();
        }

        const urunEkleModal = document.getElementById('urunEkleModal');
        urunEkleModal.addEventListener('hidden.bs.modal', function () {
            // Formu sıfırla
            const form = urunEkleModal.querySelector('form');
            form.reset();

            // Kamera alanını da gizle (aktifse)
            document.getElementById("kameraAlani").style.display = "none";

            // QR kod okuyucu temizliği
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(() => { });
            }
            location.reload(); // ekranı yenile


        });


        function numpadClick(char) {
            let input = document.getElementById("digerUrunFiyat");
            input.value += char;
        }

        function numpadBackspace() {
            let input = document.getElementById("digerUrunFiyat");
            input.value = input.value.slice(0, -1);
        }

        $('#toptanciModal').on('hidden.bs.modal', function () {
            $('#barkodInput').focus();
            location.reload(); // ekranı yenile

        });


        let iskontoUygulandi = false;
        let oncekiToplam = 0;
        let uygulananIskonto = 0;

        function applyDiscount() {
            let iskonto = parseFloat($('#iskontoOrani').val());

            if (isNaN(iskonto) || iskonto < 0 || iskonto > 100) {
                Swal.fire({
                    title: 'Geçersiz Oran',
                    text: 'Lütfen 0 ile 100 arasında bir iskonto oranı giriniz.',
                    icon: 'warning',
                    confirmButtonText: 'Tamam'
                });
                return;
            }

            // Ürün listesi boşsa uyarı verip çık
            let urunSatirSayisi = $('#urunListesi tbody tr').not('.iskonto-satiri').length;
            if (urunSatirSayisi === 0) {
                let uyarı = $('<div>')
                    .text('Ürün listesi boş. İskonto uygulanamaz.')
                    .css({
                        position: 'fixed',
                        top: '20px',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        backgroundColor: '#ffdddd',
                        color: '#a94442',
                        border: '1px solid #a94442',
                        padding: '10px 20px',
                        borderRadius: '8px',
                        zIndex: 9999,
                        fontWeight: 'bold',
                    })
                    .appendTo('body');

                setTimeout(function () {
                    uyarı.fadeOut(300, function () {
                        $(this).remove();
                    });
                }, 600); // 0.6 saniye sonra kaybolur

                return;
            }


            // Global oncekiToplam'ı güncelle
            oncekiToplam = 0;
            $('#urunListesi tbody tr').each(function () {
                let satirToplam = parseFloat($(this).find('.satirToplam').text());
                if (!isNaN(satirToplam) && !$(this).hasClass('iskonto-satiri')) {
                    oncekiToplam += satirToplam;
                }
            });

            let indirimMiktari = oncekiToplam * (iskonto / 100);
            let yeniToplam = oncekiToplam - indirimMiktari;

            // Eğer iskonto zaten uygulandıysa önce eski iskonto satırını kaldır
            if (iskontoUygulandi) {
                $('.iskonto-satiri').remove();
            }

            // İskonto satırını ekle
            $('#urunListesi tbody').append(`
                                                            <tr class="iskonto-satiri" style="background-color: #e9fbe9;">
                                                                <td colspan="3"><strong>İskonto (%${iskonto})</strong></td>
                                                                <td class="satirToplam">-${indirimMiktari.toFixed(2)}</td>
                                                                <td></td>
                                                            </tr>
                                                        `);

            $('#toplamFiyat').text(yeniToplam.toFixed(2) + ' ₺');
            $('#barkodInput').val('').focus();

            // Ürün listesini derle
            let urunListesiMetni = '';
            $('#urunListesi tbody tr').each(function () {
                let urunAdi = $(this).find('td:eq(0)').text().trim();
                let fiyat = $(this).find('td:eq(1)').text().trim();
                let adet = $(this).find('td:eq(2)').text().trim();
                let toplam = $(this).find('td:eq(3)').text().trim();

                if (!urunAdi || !toplam) return;

                urunListesiMetni += `Ürün: ${urunAdi} - Adet: ${adet} - Tutar: ${toplam} `;
            });

            if ($('#UrunListesiHidden').length === 0) {
                $('body').append('<input type="hidden" id="UrunListesiHidden" name="UrunListesi" />');
            }
            $('#UrunListesiHidden').val(urunListesiMetni.trim());

            // Durumu güncelle
            iskontoUygulandi = true;
            uygulananIskonto = iskonto;

            // Buton güncelle (önce eski eventleri kaldır)
            $('#iskontoBtn').html('<i class="fas fa-times me-2"></i>İskontoyu İptal Et');
            $('#iskontoBtn').off('click').on('click', iptalEt);
            $('#iskontoBtn').removeAttr('data-bs-toggle data-bs-target');

            $('#iskontoModal').modal('hide');
            // Modal tamamen kapandıktan sonra focus ver
            $('#iskontoModal').on('hidden.bs.modal', function () {
                setTimeout(function () {
                    $('#barkodInput').val('').focus();
                }, 100); // Modal tamamen kapandıktan 100ms sonra focus
            });

            $('#iskontoModal').modal('hide');
            setTimeout(function () {
                const input = $('#barkodInput');
                input.val('');
                input[0].scrollIntoView({ behavior: "smooth", block: "center" });
                input.focus();
            }, 100);


        }





        function iptalEt() {
            // İskonto satırını sil
            $('.iskonto-satiri').remove();

            // Durum sıfırla
            iskontoUygulandi = false;
            uygulananIskonto = 0;

            // Toplamı güncelle
            updateGenelToplam();

            // Buton metni ve işlevini güncelle
            $('#iskontoBtn').html('<i class="fas fa-percent me-2"></i>İskonto');
            $('#iskontoBtn').off('click'); // Önce varsa eski click eventlerini kaldır
            $('#iskontoBtn').prop('data-bs-toggle', 'modal');
            $('#iskontoBtn').prop('data-bs-target', '#iskontoModal');
            $('#iskontoBtn').on('click', function () {
                $('#iskontoModal').modal('show');
            });

            $('#barkodInput').val('').focus();


            // Swal alert
            Swal.fire({
                title: 'İskonto Kaldırıldı',
                text: 'Uygulanan indirim iptal edildi.',
                icon: 'info',
                timer: 600,
                showConfirmButton: false
            });

            $('#barkodInput').val('').focus();

        }

        function getMusteriBorc() {
            var id = $('#borcMusteriSelect').val();
            $('#borcMusteriId').val(id);
            $.getJSON('/Home/GetMusteriBorc', { id: id }, function (borc) {
                $('#ToplamBorc').val(borc + ' ₺');
            });
        }

        function getToptanciAlacakVerecek() {
            var id = $('#toptanciSelect').val();

            $.getJSON('/Home/GetToptanciAlacakVerecek', { id: id }, function (data) {
                $('#ToplamAlacak').text(data.Alacak + ' ₺');
                $('#ToplamVerecek').text(data.Verecek + ' ₺');

                var net = data.Alacak - data.Verecek;

                // Net durumun rengini dinamik değiştir
                var $netDurum = $('#NetDurum');
                $netDurum.text(net + ' ₺');

                if (net > 0) {
                    $netDurum.removeClass().addClass('badge bg-success fs-6');
                } else if (net < 0) {
                    $netDurum.removeClass().addClass('badge bg-danger fs-6');
                } else {
                    $netDurum.removeClass().addClass('badge bg-secondary fs-6');
                }
            });
        }

        function resetToptanci() {
            var id = $('#toptanciSelect').val();
            if (!id) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Uyarı',
                    text: 'Lütfen önce bir toptancı seçin.',
                    confirmButtonText: 'Tamam'
                });
                return;
            }

            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu toptancıya ait tüm alacak/verecek işlemleri sıfırlamak üzeresiniz!",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Evet, sıfırla',
                cancelButtonText: 'Vazgeç'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Home/ResetToptanciIslemleri', { id: id }, function (result) {
                        if (result.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Başarılı',
                                text: 'Tüm işlemler başarıyla sıfırlandı.',
                                timer: 1000,
                                timerProgressBar: true,
                                showConfirmButton: false
                            });
                            getToptanciAlacakVerecek();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata',
                                text: 'Bir hata oluştu: ' + result.message,
                                confirmButtonText: 'Kapat'
                            });
                        }
                    });
                }
            });
        }





        function submitBorcOdeForm() {
            var id = $('#borcMusteriSelect').val();
            var tutar = $('#OdenenBorcTutar').val();
            var not = $('#BorcNot').val();
            var odemeTipi = $('#OdemeTipi').val();

            if (!id || !tutar) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Eksik Bilgi',
                    text: 'Lütfen müşteri ve tutar bilgilerini girin.',
                    timer: 1000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
                return;
            }

            $.post('/Home/BorcOde', {
                id: id,
                OdenenBorcTutar: tutar,
                Not: not,
                OdemeTipi: odemeTipi
            }, function () {
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı',
                    text: 'Borç ödeme işlemi başarıyla tamamlandı.',
                    timer: 1000,
                    timerProgressBar: true,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            });
        }


        function submitToptanciIslemForm() {
            var id = $('#toptanciSelect').val();
            var tutar = $('#IslemTutar').val();
            var not = $('#ToptanciIslemNot').val();
            var islemTipi = $('#IslemTipi').val();

            if (!id || !tutar) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Eksik Bilgi',
                    text: 'Lütfen bilgileri eksiksiz girin.',
                    timer: 1000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
                return;
            }

            $.post('/Home/ToptanciIslem', {
                id: id,
                IslemTutar: tutar,
                Not: not,
                IslemTipi: islemTipi
            }, function () {
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı',
                    text: 'Toptancı işlemi başarıyla kaydedildi.',
                    timer: 1000,
                    timerProgressBar: true,
                    showConfirmButton: false
                }).then(() => {
                    getToptanciAlacakVerecek();       // Güncel değerleri göster
                    $('#IslemTutar').val('');
                });
            });
        }


        function iadeYap() {
            $('#barkodInput').val('').focus();

            Swal.fire({
                title: 'İade Onayı',
                text: 'Ürünler iade edilecektir. Onaylıyor musunuz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, Onaylıyorum',
                cancelButtonText: 'İptal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#odemeTipi').val('Iade');
                    satisYap();
                }

                $('#barkodInput').val('').focus();
            });
            $('#barkodInput').val('').focus();

        }

        let currentStep = 1;

        function showStep(step) {
            $(".wizard-step").addClass("d-none");
            $("#step" + step).removeClass("d-none");

            // Buton yönetimi
            $("#prevStepBtn").toggleClass("d-none", step === 1);
            $("#nextStepBtn").toggleClass("d-none", step === 3);
            $("#confirmBtn").toggleClass("d-none", step !== 3);

            // Progress bar
            $("#wizardProgress").css("width", (step * 33) + "%");
        }

        $("#nextStepBtn").on("click", function () {
            if (currentStep === 1 && !$("#wizardToptanciSelect").val()) {
                Swal.fire("Uyarı", "Lütfen toptancı seçin!", "warning");
                return;
            }
            if (currentStep === 2) {
                // Sol taraftaki özet
                $("#SummaryToptanci").text($("#wizardToptanciSelect option:selected").text());
                $("#SummaryTutar").text($("#WizardTutar").val() + " ₺");
                $("#SummaryTipi").text($("#WizardTipi").val());
                $("#SummaryNot").text($("#WizardNot").val());

                // Sağ taraftaki güncel finansal durum
                var alacak = parseFloat($("#WizardAlacak").text()) || 0;
                var verecek = parseFloat($("#WizardVerecek").text()) || 0;
                var net = alacak - verecek;
                var tutar = parseFloat($("#WizardTutar").val()) || 0;
                var tip = $("#WizardTipi").val();

                if (tip === "Alacak") {
                    alacak += tutar;
                } else {
                    verecek += tutar;
                }
                net = alacak - verecek;

                $("#SummaryAlacak").text(alacak + " ₺");
                $("#SummaryVerecek").text(verecek + " ₺");
                $("#SummaryNetDurum").text(net + " ₺");
            }

            currentStep++;
            showStep(currentStep);
        });


        $("#prevStepBtn").on("click", function () {
            currentStep--;
            showStep(currentStep);
        });

        $("#confirmBtn").on("click", function () {
            $.post("/Home/ToptanciIslem", {
                id: $("#wizardToptanciSelect").val(),
                IslemTutar: $("#WizardTutar").val(),
                Not: $("#WizardNot").val(),
                IslemTipi: $("#WizardTipi").val()
            }, function () {
                Swal.fire({
                    icon: "success",
                    title: "Başarılı",
                    text: "Toptancı işlemi kaydedildi",
                    timer: 1000,               // 1 saniye
                    timerProgressBar: true,    // ilerleme çubuğu
                    showConfirmButton: false,  // OK butonu yok
                    willClose: () => {
                        $("#toptanciWizardModal").modal("hide");
                    }
                });
            });
        });


        // Finansal durum getirme (wizard için)
        function getToptanciAlacakVerecekWizard() {
            var id = $('#wizardToptanciSelect').val();
            $.getJSON('/Home/GetToptanciAlacakVerecek', { id: id }, function (data) {
                var net = data.Alacak - data.Verecek;
                $('#WizardAlacak').text(data.Alacak + ' ₺');
                $('#WizardVerecek').text(data.Verecek + ' ₺');
                $('#WizardNetDurum').text(net + ' ₺');
                $('#WizardNetDurumStep2').text(net + ' ₺');
            });
        }

        // Modal açıldığında step 1’e dön
        $('#toptanciWizardModal').on('shown.bs.modal', function () {
            currentStep = 1;
            showStep(currentStep);
        });


        // Modal açıldığında her şeyi sıfırla
        $('#toptanciWizardModal').on('show.bs.modal', function () {
            // Step 1’e dön
            currentStep = 1;
            showStep(currentStep);

            // Alanları temizle
            $('#wizardToptanciSelect').val('');
            $('#WizardAlacak').text('0 ₺');
            $('#WizardVerecek').text('0 ₺');
            $('#WizardNetDurum').text('0 ₺');
            $('#WizardNetDurumStep2').text('0 ₺');
            $('#WizardTutar').val('');
            $('#WizardTipi').val('Alacak');
            $('#WizardNot').val('');
            $('#SummaryToptanci').text('');
            $('#SummaryTutar').text('');
            $('#SummaryTipi').text('');
            $('#SummaryNot').text('');
        });


        


    </script>

    <script src="https://unpkg.com/ericblade/quagga2@2.0.0-beta.3/dist/quagga.min.js"></script>

</body>
</html>
