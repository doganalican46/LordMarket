<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lord Büfe&Market Satış</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/862/862819.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="@Url.Content("~/Assets/HomeAssets/style.css")" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1><i class="fas fa-barcode me-2"></i>Lord Büfe & Market Satış</h1>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="barcode-section my-3">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-light text-dark"><i class="fas fa-barcode"></i></span>
                        <input type="text"
                               id="barkodInput"
                               class="form-control"
                               placeholder="Barkod okutun veya girin"
                               autofocus>
                        <button class="btn btn-success" onclick="barkodAraSatis()">
                            <i class="fas fa-plus me-2"></i>Ekle
                        </button>
                        <button type="button" class="btn btn-outline-dark" onclick="kameraAcSatis()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </div>


                <div id="kameraAlani" class="mt-3" style="display:none;">
                    <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
                    <button type="button" class="btn btn-danger mt-2" onclick="kamerayiKapatSatis()">Kapat</button>
                </div>

                <div class="product-table-container">
                    <table class="table table-striped table-hover" id="urunListesi">
                        <thead>
                            <tr>
                                <th>Ürün Adı</th>
                                <th>Fiyat (₺)</th>
                                <th>Adet</th>
                                <th>Toplam (₺)</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="other-product-section">
                    <h5><i class="fas fa-tag me-2"></i>Diğer Ürün Ekle</h5>
                    <div class="input-group">
                        <span class="input-group-text">Fiyat (₺)</span>
                        <input type="text" id="digerUrunFiyat" class="form-control" placeholder="Fiyat girin" >
                        <button class="btn btn-secondary" onclick="digerUrunEkle()"><i class="fas fa-plus me-2"></i>Ekle</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="total-section">
                    <div id="toplamFiyat" style="font-size: 48px; font-weight: bold; color: white;">0.00 ₺</div>
                </div>

                <div class="payment-section">
                    <h5 class="mb-3">
                        <i class="fas fa-money-bill-wave me-2 text-success"></i>Ödeme Seçenekleri
                    </h5>

                    <div class="payment-methods d-flex flex-wrap gap-3">
                        <button type="button" class="btn btn-success odeme-btn btn-lg flex-fill active" data-tip="Nakit">
                            <i class="fas fa-money-bill me-2"></i>Nakit
                        </button>
                        <button type="button" class="btn btn-info odeme-btn btn-lg flex-fill" data-tip="Kart">
                            <i class="fas fa-credit-card me-2"></i>Kart
                        </button>
                        <button type="button" class="btn btn-warning odeme-btn btn-lg flex-fill" data-tip="Veresiye">
                            <i class="fas fa-hand-holding-usd me-2"></i>Veresiye
                        </button>
                    </div>

                    <input type="hidden" id="odemeTipi" value="Nakit">

                    <div class="customer-select" id="customerSelectContainer" style="display: none;">
                        <label for="musteriSelect" class="form-label"><i class="fas fa-user me-2"></i>Müşteri Seçin:</label>
                        <select id="musteriSelect" class="form-select">
                            <option value="">Müşteri Seçin</option>
                            @foreach (var musteri in Model.Musteriler)
                            {
                                <option value="@musteri.ID">@musteri.MusteriAdSoyad</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="action-buttons d-flex gap-2 flex-wrap mb-3">

                    <button class="btn btn-danger btn-sm d-flex align-items-center px-3 py-2 shadow-sm" onclick="temizle()">
                        <i class="fas fa-trash-alt me-2"></i>Temizle
                    </button>

                    <button type="button" class="btn btn-secondary btn-sm d-flex align-items-center px-3 py-2 shadow-sm" onclick="islemBeklet()" title="İşlemi daha sonra devam etmek üzere beklet">
                        <i class="fas fa-clock me-2"></i>İşlem Beklet
                    </button>

                    <button type="button" class="btn btn-success btn-sm d-flex align-items-center px-3 py-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#urunEkleModal">
                        <i class="fas fa-plus me-2"></i>Ürün İşlem
                    </button>

                    <a href="/Admin/Index" class="btn btn-warning btn-sm d-flex align-items-center justify-content-center px-3 py-2 shadow-sm" title="Admin Ekranı">
                        <i class="fas fa-toolbox"></i>
                    </a>

                    <button type="button" class="btn btn-info btn-sm d-flex align-items-center justify-content-center px-3 py-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#makbuzModal" title="Son İşlemin Makbuzunu Yazdır">
                        🧾
                    </button>



                </div>





                <div class="quick-products">
                    <h5><i class="fas fa-bolt me-2"></i>Hızlı Ürünler</h5>
                    <div class="d-flex flex-wrap">
                        @foreach (var item in Model.HizliUrunler)
                        {
                            <button class="btn btn-danger btn-quick-product"
                                    onclick="hizliUrunEkle('@item.Barkod')"
                                    oncontextmenu="kaldirmakIcinSor(@item.ID); return false;">
                                <div>@item.UrunAd</div>
                                <div class="fw-bold">@item.UrunFiyat ₺</div>
                            </button>
                        }


                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="makbuzModal" tabindex="-1" aria-labelledby="makbuzModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content mx-auto" style="width: 100%; max-width: 58mm; padding: 0; margin: 0;">
                <div class="modal-header py-1 justify-content-center">
                    <h5 class="modal-title" id="makbuzModalLabel" style="font-size: 13px;">İşlem Makbuzu</h5>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>

                <div id="printableReceipt"
                     style="font-family: 'Courier New', monospace; font-size: 15px; width: 100%; box-sizing: border-box; padding: 2px 3px; line-height: 1.1; word-break: break-word; overflow-wrap: break-word;">

                    <div style="font-weight: bold; font-size: 15px; text-align: center; margin-bottom: 2px;">LORD BÜFE & MARKET</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 2px;">TEL: 0544 940 8134</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 2px;">-----------------------</div>

                    <div style="font-weight: bold; margin-bottom: 1px;">
                        Tarih: @(Model?.SonSatis?.Tarih?.ToString("dd.MM.yyyy HH:mm") ?? "-")
                    </div>
                    <div style="font-weight: bold; margin-bottom: 1px;">
                        Satış No: @(Model?.SonSatis?.SatisNo?.ToString() ?? "-")
                    </div>
                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>

                    <table style="width: 100%; font-size: 13px; text-align: center; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="font-weight: bold; text-align: left;">Ürün</th>
                                <th>Ad</th>
                                <th style="font-weight: bold; text-align: right;">Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!string.IsNullOrEmpty(Model?.SonSatis?.UrunListesi))
                            {
                                foreach (var satir in Model.SonSatis.UrunListesi.Split('\n'))
                                {
                                    if (string.IsNullOrWhiteSpace(satir))
                                    {
                                        continue;
                                    }

                                    var parcalar = satir.Split(new[] { " - " }, StringSplitOptions.None);
                                    string urunAd = "-", adet = "-", tutar = "-";

                                    foreach (var parca in parcalar)
                                    {
                                        if (parca.StartsWith("Ürün: "))
                                        {
                                            urunAd = parca.Replace("Ürün: ", "").Trim();
                                        }
                                        else if (parca.StartsWith("Adet: "))
                                        {
                                            adet = parca.Replace("Adet: ", "").Trim();
                                        }
                                        else if (parca.StartsWith("Tutar: "))
                                        {
                                            tutar = parca.Replace("Tutar: ", "").Trim();
                                        }
                                    }

                                    <tr>
                                        <td style="font-weight: bold; text-align: left;">@urunAd</td>
                                        <td>@adet</td>
                                        <td style="font-weight: bold; text-align: right;">@tutar</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" style="font-weight: bold; text-align: center;">Ürün listesi mevcut değil</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>

                    <div style="font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; margin-bottom: 1px;">
                        <span>Toplam:</span>
                        <span>@(Model?.SonSatis?.ToplamTutar?.ToString() ?? "-") ₺</span>
                    </div>
                    <div style="font-weight: bold; display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 2px;">
                        <span>Ödeme Tipi:</span>
                        <span>@(Model?.SonSatis?.OdemeTipi ?? "-")</span>
                    </div>

                    @if (Model?.SonSatis?.MusteriID != null)
                    {
                        <div style="font-weight: bold; margin-bottom: 2px;">Müşteri: @(Model?.MusteriAdSoyad ?? "-")</div>
                    }

                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>
                    <div style="font-weight: bold; text-align: center; margin-bottom: 2px;">MALİ DEĞERİ YOKTUR</div>
                    <div style="text-align: center; margin: 2px 0;">-----------------------</div>

                    <div style="font-weight: bold; text-align: center; font-size: 13px;">
                        ADRES: NARLI CUMHURİYET MAH.<br />
                        13007.SK NO:12/A
                    </div>
                </div>

                <div class="modal-footer py-1 justify-content-center">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="printDiv('printableReceipt')">🖨 Yazdır</button>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="urunEkleModal" tabindex="-1" aria-labelledby="urunEkleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="urunEkleModalLabel">Yeni Ürün Ekle/Güncelle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>

                <form action="/Home/YeniUrun" method="post" enctype="multipart/form-data">
                    <div class="modal-body">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="barkodInputyeniurun" class="form-label">Barkod</label>
                                <div class="input-group">
                                    <input type="text" name="Barkod" id="barkodInputyeniurun" class="form-control" required />
                                    <button type="button" class="btn btn-outline-secondary" onclick="kameraAc()">📷</button>
                                </div>
                            </div>
                            <div id="kameraAlaniyeniurun" class="mt-3" style="display:none;">
                                <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
                                <button type="button" class="btn btn-danger mt-2" onclick="kamerayiKapat()">Kapat</button>
                            </div>



                            <div class="col-md-6">
                                <label for="UrunAd" class="form-label">Ürün Adı</label>
                                <input type="text" name="UrunAd" class="form-control" required />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunKategori" class="form-label">Ürün Kategorisi</label>
                                <input type="text" name="UrunKategori" class="form-control" />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunAlisFiyati" class="form-label">Ürün Alış Fiyatı</label>
                                <input type="number" step="0.01" name="UrunAlisFiyati" id="UrunAlisFiyati" class="form-control" />
                            </div>

                            <div class="col-md-6">
                                <label for="KDVOran" class="form-label">KDV Oranı (%)</label>
                                <input type="number" step="0.01" name="KDVOran" id="KDVOran" class="form-control" value="18" />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunFiyat" class="form-label">Hesaplanan Ürün Fiyatı</label>
                                <input type="number" step="0.01" name="UrunFiyat" id="UrunFiyat" class="form-control" required />
                            </div>

                            <div class="col-md-6">
                                <label for="UrunResmi" class="form-label">Ürün Resmi</label>
                                <input type="text" name="UrunResmi" class="form-control" />
                            </div>

                            <div class="col-md-6 mt-4 d-flex align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="HizliUrunMu" value="true" id="HizliUrunMu" />
                                    <label class="form-check-label" for="HizliUrunMu">Hızlı Ürün mü?</label>
                                </div>
                                <input type="hidden" name="HizliUrunMu" value="false" />
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Kaydet</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>

        const alisInput = document.getElementById("UrunAlisFiyati");
        const kdvInput = document.getElementById("KDVOran");
        const fiyatInput = document.getElementById("UrunFiyat");

        function hesaplaFiyat() {
            let alis = parseFloat(alisInput.value) || 0;
            let kdv = parseFloat(kdvInput.value) || 0;
            let hesaplanan = alis + (alis * kdv / 100);
            fiyatInput.value = hesaplanan.toFixed(2);
        }

        alisInput.addEventListener("input", hesaplaFiyat);
        kdvInput.addEventListener("input", hesaplaFiyat);

        let html5QrCode;


        function kameraAc() {
            document.getElementById("kameraAlaniyeniurun").style.display = "block";

            html5QrCode = new Html5Qrcode("reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Arka kamera olup olmadığını kontrol et
                    let backCamera = devices.find(device => device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("environment"));
                    let kameraId = backCamera ? backCamera.id : devices[0].id;

                    html5QrCode.start(
                        kameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        decodedText => {
                            document.getElementById("barkodInputyeniurun").value = decodedText;
                            kamerayiKapat();
                        },
                        errorMessage => {
                            // Hataları sessizce geç
                        }
                    );
                }
            }).catch(err => {
                alert("Kamera erişim hatası: " + err);
            });
        }

        function kamerayiKapat() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById("kameraAlaniyeniurun").style.display = "none";
                });
            }
        }






        function kameraAcSatis() {
            document.getElementById("kameraAlani").style.display = "block";

            html5QrCode = new Html5Qrcode("reader");

            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    let backCamera = devices.find(device => device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("environment"));
                    let kameraId = backCamera ? backCamera.id : devices[0].id;

                    html5QrCode.start(
                        kameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        decodedText => {
                            document.getElementById("barkodInput").value = decodedText;
                            kamerayiKapatSatis();
                            barkodAra();
                        },
                        errorMessage => {
                            // Hataları sessizce geç
                        }
                    );
                }
            }).catch(err => {
                alert("Kamera erişim hatası: " + err);
            });
        }

        window.onload = function () {
            $('#barkodInput').val("").focus();
        };



        function kamerayiKapatSatis() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById("kameraAlani").style.display = "none";
                });
            }
        }

        document.getElementById("barkodInputyeniurun").addEventListener("change", function () {
            const barkod = this.value;

            if (barkod.trim() === "") return;

            fetch(`/Home/BarkodAraYeniUrun?barkod=${encodeURIComponent(barkod)}`)
                .then(response => {
                    if (!response.ok) throw new Error("Sunucu hatası");
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        document.querySelector('input[name="UrunAd"]').value = data.UrunAd || "";
                        document.querySelector('input[name="UrunKategori"]').value = data.UrunKategori || "";
                        document.querySelector('input[name="UrunAlisFiyati"]').value = data.UrunAlisFiyati || "";
                        document.querySelector('input[name="KDVOran"]').value = data.KDVOran || "";
                        document.querySelector('input[name="UrunFiyat"]').value = data.UrunFiyat || "";
                        document.querySelector('input[name="UrunResmi"]').value = data.UrunResmi || "";

                        if (data.HizliUrunMu === true) {
                            document.getElementById("HizliUrunMu").checked = true;
                        } else {
                            document.getElementById("HizliUrunMu").checked = false;
                        }
                    }
                })
                .catch(error => {
                    console.error("Hata:", error);
                });
        });

        function islemBeklet() {
            Swal.fire({
                icon: 'info',
                title: 'Bilgi',
                text: 'Bu fonksiyon şu anda aktif değildir.',
                confirmButtonText: 'Tamam'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#barkodInput').val("").focus();
                }
            });
        }


        function kaldirmakIcinSor(id) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu ürünü hızlı ürünlerden kaldırmak istiyor musunuz?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, kaldır!',
                cancelButtonText: 'Vazgeç',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6'
            }).then((result) => {
                if (result.isConfirmed) {
                    // AJAX ile hızlı üründen kaldır
                    $.ajax({
                        url: '/Home/HizliUrunKaldir', // bu route senin controllerda olacak
                        type: 'POST',
                        data: { id: id },
                        success: function () {
                            Swal.fire({
                                icon: 'success',
                                title: 'Kaldırıldı!',
                                text: 'Ürün hızlı ürünlerden kaldırıldı.',
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload(); // ekranı yenile
                            });
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'Hata!',
                                text: 'Ürün kaldırılamadı.',
                            });
                        }
                    });
                }
            });
        }


        $(document).ready(function () {
            if (localStorage.getItem('fisYazdirClicked') === 'true') {
                localStorage.removeItem('fisYazdirClicked'); // işaret kaldır
                // Otomatik olarak makbuz modal butonuna tıkla
                $('button[data-bs-target="#makbuzModal"]').trigger('click');
            }
        });

        var toplam = 0;
        let digerUrunSayac = 0;

        function temizle() {
            $('#urunListesi tbody').empty();
            toplam = 0;
            $('#toplamFiyat').text("0.00 ₺");
            $('#barkodInput').val('').focus();
            $('#odemeTipi').val('Nakit');
            $('.odeme-btn').removeClass('active');
            $('.odeme-btn[data-tip="Nakit"]').addClass('active');
            $('#musteriSelect').val('');
            $('#customerSelectContainer').hide();
            $('#barkodInput').val('').focus();
        }

        function updateGenelToplam() {
            let toplamYeni = 0;
            $('#urunListesi tbody tr').each(function () {
                let satirToplam = parseFloat($(this).find('.satirToplam').text());
                toplamYeni += satirToplam;
            });
            toplam = toplamYeni;
            $('#toplamFiyat').text(toplam.toFixed(2) + ' ₺');
        }

        function barkodAra() {
            var barkod = $('#barkodInput').val();
            if (barkod.trim() === "") return;

            let mevcutSatir = $(`#urunListesi tbody tr[data-barkod='${barkod}']`);
            if (mevcutSatir.length > 0) {
                let adetCell = mevcutSatir.find('.adet');
                let yeniAdet = parseInt(adetCell.text()) + 1;
                adetCell.text(yeniAdet);

                let fiyat = parseFloat(mevcutSatir.find('.fiyat').text());
                mevcutSatir.find('.satirToplam').text((yeniAdet * fiyat).toFixed(2));

                updateGenelToplam();
                $('#barkodInput').val("").focus();
                return;
            }

            $.ajax({
                url: '/Home/BarkodAra',
                type: 'POST',
                data: { barkod: barkod },
                success: function (res) {
                    if (res.success) {
                        let toplamSatir = res.fiyat;

                        $('#urunListesi tbody').append(
                            `<tr data-barkod="${barkod}">
                                                                                    <td>${res.urunAd}</td>
                                                                                    <td class="fiyat">${res.fiyat}</td>
                                                                                    <td class="adet">1</td>
                                                                                    <td class="satirToplam">${toplamSatir}</td>
                                                                                    <td>
                                                                                        <button class="btn btn-sm btn-primary" onclick="adetDegistir(this, 1)"><i class="fas fa-plus"></i></button>
                                                                                        <button class="btn btn-sm btn-warning" onclick="adetDegistir(this, -1)"><i class="fas fa-minus"></i></button>
                                                                                        <button class="btn btn-sm btn-danger" onclick="sil(this)"><i class="fas fa-trash"></i></button>
                                                                                    </td>
                                                                                </tr>`
                        );
                        updateGenelToplam();
                        $('#barkodInput').val("").focus();
                    } else {
                        Swal.fire({
                            title: 'Ürün bulunamadı',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Tamam',
                            cancelButtonText: 'Ürün Ekle',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.dismiss === Swal.DismissReason.cancel) {
                                // Barkod değerini ürün ekleme modalındaki input'a ata
                                $('#barkodInputyeniurun').val(barkod);

                                // Modalı aç
                                var myModal = new bootstrap.Modal(document.getElementById('urunEkleModal'));
                                myModal.show();
                            }
                        });

                        $('#barkodInput').val("").focus();
                    }

                },
                error: function () {
                    Swal.fire({
                        title: 'Bir hata oluştu',
                        text: 'Lütfen tekrar deneyin.',
                        icon: 'error',
                        confirmButtonText: 'Tamam'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.reload();
                        }
                    });
                }
            });
        }

        function adetDegistir(btn, degisim) {
            let satir = $(btn).closest('tr');
            let adetCell = satir.find('.adet');
            let adet = parseInt(adetCell.text());

            adet += degisim;
            if (adet < 1) return;

            adetCell.text(adet);

            let fiyat = parseFloat(satir.find('.fiyat').text());
            satir.find('.satirToplam').text((adet * fiyat).toFixed(2));
            $('#barkodInput').val('').focus();
            updateGenelToplam();
        }

        function sil(btn) {
            $(btn).closest('tr').remove();
            $('#barkodInput').val('').focus();
            updateGenelToplam();
        }

        $('#barkodInput').keypress(function (e) {
            if (e.which == 13) {
                barkodAra();
                e.preventDefault();
            }
        });

        function satisYap() {
            let odemeTipi = $('#odemeTipi').val();
            let musteriID = odemeTipi === 'Veresiye' ? $('#musteriSelect').val() : null;

            let urunlerText = '';
            let urunSatirlari = $('#urunListesi tbody tr');

            if (urunSatirlari.length === 0) {
                Swal.fire({
                    title: 'Ürün listesi boş!',
                    text: 'Lütfen önce ürün ekleyin.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Tamam',
                    cancelButtonText: 'Ürün Ekle',
                    reverseButtons: true
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        var modal = new bootstrap.Modal(document.getElementById('urunEkleModal'));
                        modal.show();
                    } else {
                        $('#barkodInput').focus();
                        location.reload();
                    }
                });
                return;
            }

            if (odemeTipi === 'Veresiye' && (!musteriID || musteriID === "")) {
                Swal.fire({
                    title: 'Uyarı',
                    text: 'Veresiye satış için müşteri seçmelisiniz.',
                    icon: 'info',
                    confirmButtonText: 'Tamam'
                }).then(() => {
                    $('#barkodInput').focus();

                });
                return;
            }

            urunSatirlari.each(function () {
                let urunAd = $(this).find('td:eq(0)').text().trim();
                let adet = $(this).find('.adet').text().trim();
                let fiyat = $(this).find('.fiyat').text().trim();
                urunlerText += `Ürün: ${urunAd} - Adet: ${adet} - Tutar: ${fiyat}\n`;
            });

            $.ajax({
                url: '/Home/SatisYap',
                type: 'POST',
                data: {
                    OdemeTipi: odemeTipi,
                    UrunListesi: urunlerText,
                    MusteriID: musteriID
                },
                success: function (res) {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Satış Tamamlandı!',
                            text: 'Satış işlemi başarıyla gerçekleştirildi.',
                            confirmButtonText: 'Tamam',
                            showCancelButton: true,
                            cancelButtonText: 'Fiş Yazdır',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.isConfirmed) {
                                temizle();
                                $('#barkodInput').focus();
                                location.reload();
                            } else if (result.dismiss === Swal.DismissReason.cancel) {
                                localStorage.setItem('fisYazdirClicked', 'true');
                                Swal.fire({
                                    title: 'Fiş hazırlanıyor...',
                                    timer: 2400,
                                    timerProgressBar: true,
                                    didOpen: () => {
                                        Swal.showLoading();
                                    },
                                    willClose: () => {
                                        temizle();
                                        location.reload();
                                    }
                                });
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Hata',
                            text: 'Hata: ' + res.message,
                            icon: 'error',
                            confirmButtonText: 'Tamam'
                        }).then(() => {
                            $('#barkodInput').focus();
                        });
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire({
                        title: 'Hata',
                        text: 'Satış işlemi sırasında sistemsel bir hata oluştu.',
                        icon: 'error',
                        confirmButtonText: 'Tamam'
                    }).then(() => {
                        $('#barkodInput').focus();
                        location.reload();
                    });
                    console.error("Hata Detayı:", xhr.responseText, status, error);
                }
            });
        }


        function hizliUrunEkle(barkod) {
            $('#barkodInput').val(barkod);
            barkodAra();
        }

        function digerUrunEkle() {
            let fiyatInput = $('#digerUrunFiyat');
            let fiyat = parseFloat(fiyatInput.val());

            if (isNaN(fiyat) || fiyat <= 0) {
                Swal.fire({
                    title: 'Geçersiz Fiyat',
                    text: 'Lütfen geçerli bir fiyat girin.',
                    icon: 'warning',
                    confirmButtonText: 'Tamam'
                });
                fiyatInput.value = "";
                fiyatInput.focus();
                return;
            }

            digerUrunSayac++;
            let barkodDegeri = `digerUrun${digerUrunSayac}`;
            let urunAdi = digerUrunSayac === 1 ? "Diğer Ürün" : `Diğer Ürün ${digerUrunSayac}`;

            $('#urunListesi tbody').append(
                `<tr data-barkod="${barkodDegeri}">
                                                                        <td>${urunAdi}</td>
                                                                        <td class="fiyat">${fiyat.toFixed(2)}</td>
                                                                        <td class="adet">1</td>
                                                                        <td class="satirToplam">${fiyat.toFixed(2)}</td>
                                                                        <td>
                                                                            <button class="btn btn-sm btn-primary" onclick="adetDegistir(this, 1)"><i class="fas fa-plus"></i></button>
                                                                            <button class="btn btn-sm btn-warning" onclick="adetDegistir(this, -1)"><i class="fas fa-minus"></i></button>
                                                                            <button class="btn btn-sm btn-danger" onclick="sil(this)"><i class="fas fa-trash"></i></button>
                                                                        </td>
                                                                    </tr>`
            );

            updateGenelToplam();
            fiyatInput.val("");
            barkodInput.focus();
        }

        $('.odeme-btn').click(function () {
            $('.odeme-btn').removeClass('active');
            $(this).addClass('active');

            let secilenTip = $(this).data('tip');
            $('#odemeTipi').val(secilenTip);

            if (secilenTip === 'Veresiye') {
                $('#customerSelectContainer').show();
            } else {
                $('#customerSelectContainer').hide();
                $('#musteriSelect').val('');
            }
        });

        $(document).ready(function () {
            $('#barkodInput').focus();
        });

        $(document).ready(function () {
            $(".odeme-btn").click(function () {
                $(".odeme-btn").removeClass("active");
                $(this).addClass("active");

                var tip = $(this).data("tip");
                $("#odemeTipi").val(tip);

                if (tip === "Veresiye") {
                    $("#customerSelectContainer").slideDown();
                } else {
                    $("#customerSelectContainer").slideUp();
                }

                if (tip === "Veresiye") {
                    if ($("#musteriSelect").val()) {
                        satisYap();
                    } else {
                        $("#musteriSelect").off("change").on("change", function () {
                            if ($(this).val()) {
                                satisYap();
                            }
                        });
                    }
                } else {
                    satisYap();
                }
            });
        });
        function printDiv(divId) {
            var printContents = document.getElementById(divId).innerHTML;
            var originalContents = document.body.innerHTML;

            document.body.innerHTML = '<div style="width: 58mm; margin: 0 auto; font-family: \'Courier New\', monospace; font-size: 11px; font-weight: bold; box-sizing: border-box;">' + printContents + '</div>';

            window.print();

            document.body.innerHTML = originalContents;
            location.reload();
        }
        const urunEkleModal = document.getElementById('urunEkleModal');
        urunEkleModal.addEventListener('hidden.bs.modal', function () {
            // Formu sıfırla
            const form = urunEkleModal.querySelector('form');
            form.reset();

            // Kamera alanını da gizle (aktifse)
            document.getElementById("kameraAlani").style.display = "none";

            // QR kod okuyucu temizliği
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(() => { });
            }
        });

    </script>

    <script src="https://unpkg.com/ericblade/quagga2@2.0.0-beta.3/dist/quagga.min.js"></script>

</body>
</html>