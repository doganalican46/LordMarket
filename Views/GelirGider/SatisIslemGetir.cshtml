@model LordMarket.Models.SatisIslem

@{
    ViewBag.Title = "Satış İşlem Detay";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var urunSatirlari = (Model.UrunListesi ?? "").Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Satış İşlem Detay</h3>
    <div>
        <a href="@Url.Action("RaporPaneli", "GelirGider")" class="btn btn-secondary">← Geri Dön</a>
    </div>
</div>

<!-- Müşteri Bilgileri -->
@if (Model.MusteriID != null)
{
    <div class="mb-4">
        <h5><strong>Müşteri Bilgileri</strong></h5>
        <table class="table table-bordered table-sm w-50">
            <tbody>
                <tr>
                    <th>Müşteri ID</th>
                    <td>
                        @Model.MusteriID
                        <a href="@Url.Action("MusteriGetir", "Musteri", new { id = Model.MusteriID })"
                           class="btn btn-sm btn-outline-primary ms-2"
                           title="Müşteri Detayına Git">
                            <i class="bi bi-person-lines-fill"></i>
                        </a>
                    </td>
                </tr>
                <tr>
                    <th>Ad Soyad</th>
                    <td>@ViewBag.MusteriAdSoyad</td>
                </tr>
            </tbody>
        </table>
    </div>
}
else
{
    <div class="mb-4">
        <h5><strong>Müşteri Bilgileri</strong></h5>
        <div class="alert alert-warning p-2">Müşteri kaydı yok.</div>
    </div>
}

<!-- Genel Satış Bilgileri -->
<div class="table-responsive mb-4" id="printArea">
    <table class="table table-bordered table-sm text-center">
        <thead class="table-light">
            <tr>
                <th>Satış No</th>
                <th class="text-center">Toplam Tutar</th>
                <th class="text-center">Tarih</th>
                <th class="text-center">Ödeme Tipi</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@Model.SatisNo</td>
                <td>@Model.ToplamTutar ₺</td>
                <td>@(Model.Tarih.HasValue ? Model.Tarih.Value.ToString("dd.MM.yyyy HH:mm") : "-")</td>
                <td>@Model.OdemeTipi</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="mb-4">
    <h5><strong>İşlem Makbuzu</strong></h5>
</div>

<!-- Makbuzu Göster Butonu -->
<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#makbuzModal">
    🧾 Makbuzu Göster
</button>

<!-- Modal -->
<div class="modal fade" id="makbuzModal" tabindex="-1" aria-labelledby="makbuzModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="makbuzModalLabel">İşlem Makbuzu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body" id="printableReceipt">
                <div class="border p-3" style="font-family: 'Courier New', Courier, monospace; white-space: pre-line;">
                    <div class="text-center mb-3" style="font-weight: bold; font-size: 1.2rem;">
                        LORD TEKEL BÜFE
                    </div>
                    <div>
                        Tarih: @(Model.Tarih.HasValue ? Model.Tarih.Value.ToString("dd.MM.yyyy HH:mm") : "-")
                    </div>
                    <div>
                        Satış No: @Model.SatisNo
                    </div>
                    <hr />
                    <div><strong>Ürünler:</strong></div>
                    <table class="table table-borderless table-sm" style="font-family: monospace;">
                        <thead>
                            <tr>
                                <th>Ürün Adı</th>
                                <th class="text-center">Adet</th>
                                <th class="text-end">Tutar (₺)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var satir in urunSatirlari)
                            {
                                var parcalar = satir.Split(new[] { " - " }, StringSplitOptions.None);
                                string urunAd = "";
                                string adet = "";
                                string tutar = "";

                                foreach (var parca in parcalar)
                                {
                                    if (parca.StartsWith("Ürün: "))
                                    {
                                        urunAd = parca.Replace("Ürün: ", "").Trim();
                                    }
                                    else if (parca.StartsWith("Adet: "))
                                    {
                                        adet = parca.Replace("Adet: ", "").Trim();
                                    }
                                    else if (parca.StartsWith("Tutar: "))
                                    {
                                        tutar = parca.Replace("Tutar: ", "").Trim();
                                    }
                                }
                                <tr>
                                    <td>@urunAd</td>
                                    <td class="text-center">@adet</td>
                                    <td class="text-end">@tutar</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <hr />
                    <div class="d-flex justify-content-between" style="font-weight: bold;">
                        <span>Toplam:</span>
                        <span>@Model.ToplamTutar ₺</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Ödeme Tipi:</span>
                        <span>@Model.OdemeTipi</span>
                    </div>
                    @if (Model.MusteriID != null)
                    {
                        <div class="mt-3">
                            <strong>Müşteri Adı:</strong> @ViewBag.MusteriAdSoyad
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" onclick="printDiv('printableReceipt')">🖨 Yazdır</button>
            </div>
        </div>
    </div>
</div>

<script>
    function printDiv(divId) {
        var printContents = document.getElementById(divId).innerHTML;
        var originalContents = document.body.innerHTML;

        document.body.innerHTML = printContents;
        window.print();
        document.body.innerHTML = originalContents;

        location.reload();
    }
</script>

