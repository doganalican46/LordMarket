@model LordMarket.Models.SatisIslem

@{
    ViewBag.Title = "Satış İşlem Detay";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var urunSatirlari = (Model.UrunListesi ?? "").Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Satış İşlem Detay</h3>
    <div>
        <a href="@Url.Action("RaporPaneli", "GelirGider")" class="btn btn-secondary">← Geri Dön</a>
    </div>
</div>

<!-- Müşteri Bilgileri -->
@if (Model.MusteriID != null)
{
    <div class="mb-4">
        <h5><strong>Müşteri Bilgileri</strong></h5>
        <table class="table table-bordered table-sm w-50">
            <tbody>
                <tr>
                    <th>Müşteri ID</th>
                    <td>
                        @Model.MusteriID
                        <a href="@Url.Action("MusteriGetir", "Musteri", new { id = Model.MusteriID })"
                           class="btn btn-sm btn-outline-primary ms-2"
                           title="Müşteri Detayına Git">
                            <i class="bi bi-person-lines-fill"></i>
                        </a>
                    </td>
                </tr>
                <tr>
                    <th>Ad Soyad</th>
                    <td>@ViewBag.MusteriAdSoyad</td>
                </tr>
            </tbody>
        </table>
    </div>
}
else
{
    <div class="mb-4">
        <h5><strong>Müşteri Bilgileri</strong></h5>
        <div class="alert alert-warning p-2">Müşteri kaydı yok.</div>
    </div>
}

<!-- Genel Satış Bilgileri -->
<div class="table-responsive mb-4" id="printArea">
    <table class="table table-bordered table-sm text-center">
        <thead class="table-light">
            <tr>
                <th>Satış No</th>
                <th class="text-center">Toplam Tutar</th>
                <th class="text-center">Tarih</th>
                <th class="text-center">Ödeme Tipi</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@Model.SatisNo</td>
                <td>@Model.ToplamTutar ₺</td>
                <td>@(Model.Tarih.HasValue ? Model.Tarih.Value.ToString("dd.MM.yyyy HH:mm") : "-")</td>
                <td>@Model.OdemeTipi</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="mb-4">
    <h5><strong>İşlem Makbuzu</strong></h5>
</div>

<!-- Makbuzu Göster Butonu -->
<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#makbuzModal">
    🧾 Makbuzu Göster
</button>

<!-- Modal -->
<div class="modal fade" id="makbuzModal" tabindex="-1" aria-labelledby="makbuzModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" style="display: flex; justify-content: center; align-items: center;">
        <div class="modal-content" style="margin: 0 auto;">
            <div class="modal-header py-1">
                <h5 class="modal-title" id="makbuzModalLabel" style="font-size: 16px;">İşlem Makbuzu</h5>
                <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div  id="printableReceipt" style="font-family: 'Courier New', monospace; font-size: 14px; width: 58mm; margin: 0 auto; padding-left: 6px; font-weight: bold; box-sizing: border-box;">
                <div style="text-align: center; font-size: 17px; margin-bottom: 5px;">
                    LORD BÜFE & MARKET
                </div>
                <div style="text-align: center; font-size: 14px; margin-bottom: 5px;">
                    TEL: 0544 940 8134
                </div>
                <div style="text-align: center; font-size: 15px; margin-bottom: 5px;">-----------------------</div>

                <div style="margin-bottom: 6px; font-size: 14px;">Tarih: @(Model.Tarih.HasValue ? Model.Tarih.Value.ToString("dd.MM.yyyy HH:mm") : "-")</div>
                <div style="margin-bottom: 6px; font-size: 14px;">Satış No: @Model.SatisNo</div>
                <div style="text-align: center; font-size: 15px; margin-bottom: 5px;">-----------------------</div>

                <div style="display: flex; justify-content: space-between; font-size: 15px; border-bottom: 1px dashed black; padding-bottom: 3px; margin-bottom: 5px;">
                    <span style="flex: 1.3; font-weight: bold;">Ürün</span>
                    <span style="flex: 0.6; text-align: center; font-weight: bold;">Adet</span>
                    <span style="flex: 1.2; text-align: right; font-weight: bold;">Tutar</span>
                </div>


                @foreach (var satir in urunSatirlari)
                {
                    var parcalar = satir.Split(new[] { " - " }, StringSplitOptions.None);
                    string urunAd = "";
                    string adet = "";
                    string tutar = "";

                    foreach (var parca in parcalar)
                    {
                        if (parca.StartsWith("Ürün: "))
                        {
                            urunAd = parca.Replace("Ürün: ", "").Trim();
                        }
                        else if (parca.StartsWith("Adet: "))
                        {
                            adet = parca.Replace("Adet: ", "").Trim();
                        }
                        else if (parca.StartsWith("Tutar: "))
                        {
                            tutar = parca.Replace("Tutar: ", "").Trim();
                        }
                    }

                    if (urunAd.Length > 20)
                    {
                        urunAd = urunAd.Substring(0, 17) + "...";
                    }

                    <div style="display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 3px;">
                        <span style="flex: 1.3;">@urunAd</span>
                        <span style="flex: 0.6; text-align: center;">@adet</span>
                        <span style="flex: 1.2; text-align: right;">@tutar</span>
                    </div>

                }

            <div style="text-align: center; font-size: 15px; margin: 7px 0;">-----------------------</div>

                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 18px; font-weight: 900;">
                    <span>Toplam:</span>
                    <span>@Model.ToplamTutar ₺</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 7px; font-size: 15px;">
                    <span>Ödeme Tipi:</span>
                    <span>@Model.OdemeTipi</span>
                </div>

                @if (Model.MusteriID != null)
                {
                    <div style="margin-bottom: 6px; font-size: 14px;">Müşteri: @ViewBag.MusteriAdSoyad</div>
                }

            <div style="text-align: center; font-size: 15px; margin: 7px 0;">-----------------------</div>
                <div style="text-align: center; font-size: 14px; margin-bottom: 6px;">MALİ DEĞERİ YOKTUR</div>
                <div style="text-align: center; font-size: 14px; margin: 7px 0;">-----------------------</div>

                <div style="text-align: center; font-size: 14px;">
                    ADRES: NARLI CUMHURİYET MAH.<br />
                    13007.SK NO:12/A
                </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="printDiv('printableReceipt')">🖨 Yazdır</button>
            </div>
        </div>
    </div>
</div>


<script>
    function printDiv(divId) {
        var printContents = document.getElementById(divId).innerHTML;
        var originalContents = document.body.innerHTML;

        document.body.innerHTML = '<div style="width: 58mm; margin: 0 auto; font-family: \'Courier New\', monospace; font-size: 11px; font-weight: bold; box-sizing: border-box;">' + printContents + '</div>';

        window.print();

        document.body.innerHTML = originalContents;
        location.reload();
    }
</script>


