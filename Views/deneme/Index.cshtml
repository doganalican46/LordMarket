@model LordMarket.Controllers.denemeController.SatisIslemViewModel1
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Barkodlu Satış</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <h2>Barkodlu Satış Ekranı</h2>

    <label>Barkod Girin:</label>
    <input type="text" id="barkodInput" placeholder="Barkod okutunuz" class="form-control" />
    <button onclick="barkodAra()">Ekle</button>

    <hr />

    <table border="1" id="urunListesi">
        <thead>
            <tr>
                <th>Ürün Adı</th>
                <th>Fiyat</th>
                <th>Adet</th>
                <th>Toplam</th>
                <th>İşlem</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Genel Toplam: <span id="toplamFiyat">0</span> ₺</h3>

    <label>Ödeme Tipi:</label>
    <select id="odemeTipi">
        <option value="Nakit">Nakit</option>
        <option value="Kart">Kart</option>
        <option value="Veresiye">Veresiye</option>
    </select>

    <div id="musteriSecimAlani" style="display:block;">
        <label>Müşteri Seçin</label>
        <select id="MusteriID" name="MusteriID" class="form-control">
            <option value="">Müşteri Seçiniz</option>
            @foreach (var m in Model.Musteriler)
            {
                <option value="@m.ID">@m.MusteriAdSoyad</option>
            }
        </select>
    </div>

    <button onclick="satisYap()">Satış Yap</button>

    <br /><br />

    <h3>Hızlı Ürünler</h3>
    <div id="hizliUrunler" style="display: flex; flex-wrap: wrap; gap: 10px;">
        @foreach (var item in Model.HizliUrunler)
        {
            <button class="btn btn-warning" onclick="hizliUrunEkle('@item.Barkod')" style="min-width: 100px; margin:5px;">
                @item.UrunAd <br />
                @item.UrunFiyat ₺
            </button>
        }
    </div>

    <h3>Barkodsuz Ürün Satış</h3>
    <label>Ürün Adı:</label>
    <input type="text" id="digerUrunAd" class="form-control" placeholder="Ürün adı (isteğe bağlı)" />

    <label>Fiyat:</label>
    <input type="number" step="0.01" id="digerUrunFiyat" class="form-control" placeholder="Fiyat girin" />

    <button onclick="digerUrunEkle()">Diğer Ürün Ekle</button>



    <script>
        var toplam = 0;

        function updateGenelToplam() {
            let toplamYeni = 0;
            $('#urunListesi tbody tr').each(function () {
                let satirToplam = parseFloat($(this).find('.satirToplam').text());
                toplamYeni += satirToplam;
            });
            toplam = toplamYeni;
            $('#toplamFiyat').text(toplam.toFixed(2));
        }

        function barkodAra() {
            var barkod = $('#barkodInput').val();
            if (barkod.trim() === "") return;

            let mevcutSatir = $(`#urunListesi tbody tr[data-barkod='${barkod}']`);
            if (mevcutSatir.length > 0) {
                let adetCell = mevcutSatir.find('.adet');
                let yeniAdet = parseInt(adetCell.text()) + 1;
                adetCell.text(yeniAdet);

                let fiyat = parseFloat(mevcutSatir.find('.fiyat').text());
                mevcutSatir.find('.satirToplam').text((yeniAdet * fiyat).toFixed(2));

                updateGenelToplam();
                $('#barkodInput').val("").focus();
                return;
            }

            $.ajax({
                url: '/deneme/BarkodAra',
                type: 'POST',
                data: { barkod: barkod },
                success: function (res) {
                    if (res.success) {
                        $('#urunListesi tbody').append(`
                                                <tr data-barkod="${barkod}">
                                                    <td>${res.urunAd}</td>
                                                    <td class="fiyat">${res.fiyat}</td>
                                                    <td class="adet">1</td>
                                                    <td class="satirToplam">${res.fiyat}</td>
                                                    <td>
                                                        <button onclick="adetDegistir(this, 1)">+</button>
                                                        <button onclick="adetDegistir(this, -1)">-</button>
                                                        <button onclick="sil(this)">Sil</button>
                                                    </td>
                                                </tr>`);
                        updateGenelToplam();
                        $('#barkodInput').val("").focus();
                    } else {
                        alert(res.message);
                        $('#barkodInput').val("").focus();
                    }
                },
                error: function () {
                    alert("Bir hata oluştu.");
                }
            });
        }

        function adetDegistir(btn, degisim) {
            let satir = $(btn).closest('tr');
            let adetCell = satir.find('.adet');
            let adet = parseInt(adetCell.text()) + degisim;

            if (adet < 1) return;

            adetCell.text(adet);
            let fiyat = parseFloat(satir.find('.fiyat').text());
            satir.find('.satirToplam').text((adet * fiyat).toFixed(2));

            updateGenelToplam();
        }

        function sil(btn) {
            $(btn).closest('tr').remove();
            updateGenelToplam();
        }

        function satisYap() {
            // Eğer tabloda hiç ürün yoksa uyarı ver
            if ($('#urunListesi tbody tr').length === 0) {
                alert("Lütfen ürün ekleyin.");
                return;
            }

            let odemeTipi = $('#odemeTipi').val();
            let toplamTutar = toplam;
            let musteriId = odemeTipi === "Veresiye" ? $('#MusteriID').val() : null;
            let urunlerText = '';

            $('#urunListesi tbody tr').each(function () {
                let urunAd = $(this).find('td:eq(0)').text();
                let adet = $(this).find('.adet').text();
                let fiyat = $(this).find('.fiyat').text();
                urunlerText += `${urunAd} - ${adet} Adet - ${fiyat}₺\n`;
            });

            $.ajax({
                url: '/deneme/SatisYap',
                type: 'POST',
                data: {
                    OdemeTipi: odemeTipi,
                    ToplamTutar: toplamTutar,
                    UrunListesi: urunlerText,
                    MusteriID: musteriId
                },
                success: function (res) {
                    if (res.success) {
                        alert("Satış tamamlandı!");
                        $('#urunListesi tbody').empty();
                        $('#toplamFiyat').text("0");
                        toplam = 0;
                    } else {
                        alert("Hata: " + res.message);
                    }
                },
                error: function () {
                    alert("Satış işlemi sırasında hata oluştu.");
                }
            });
        }

        function hizliUrunEkle(barkod) {
            $('#barkodInput').val(barkod);
            barkodAra();
        }

        $(document).ready(function () {
            $('#barkodInput').on('keypress', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    barkodAra();
                }
            });

            $("#odemeTipi").on("change", function () {
                if ($(this).val() === "Veresiye") {
                    $("#musteriSecimAlani").show();
                } else {
                    $("#musteriSecimAlani").hide();
                }
            });

            $('#barkodInput').val('').focus();
        });

        function digerUrunEkle() {
            var urunAd = $('#digerUrunAd').val().trim();
            var fiyat = parseFloat($('#digerUrunFiyat').val());

            if (isNaN(fiyat) || fiyat <= 0) {
                alert("Geçerli bir fiyat giriniz.");
                return;
            }

            if (urunAd === "") {
                urunAd = "Diğer Ürün";
            }

            var barkod = "diger-" + new Date().getTime(); // benzersiz barkod üret

            $('#urunListesi tbody').append(`
            <tr data-barkod="${barkod}">
                <td>${urunAd}</td>
                <td class="fiyat">${fiyat.toFixed(2)}</td>
                <td class="adet">1</td>
                <td class="satirToplam">${fiyat.toFixed(2)}</td>
                <td>
                    <button onclick="adetDegistir(this, 1)">+</button>
                    <button onclick="adetDegistir(this, -1)">-</button>
                    <button onclick="sil(this)">Sil</button>
                </td>
            </tr>
        `);

            updateGenelToplam();

            $('#digerUrunAd').val('');
            $('#digerUrunFiyat').val('');
        }





    </script>
</body>
</html>
